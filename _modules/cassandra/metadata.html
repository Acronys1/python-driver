<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>cassandra.metadata &#8212; Cassandra Driver 3.12.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.12.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Cassandra Driver 3.12.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../cassandra.html" accesskey="U">cassandra</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for cassandra.metadata</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2013-2017 DataStax, Inc.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="kn">from</span> <span class="nn">binascii</span> <span class="k">import</span> <span class="n">unhexlify</span>
<span class="kn">from</span> <span class="nn">bisect</span> <span class="k">import</span> <span class="n">bisect_right</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Mapping</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">total_ordering</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="k">import</span> <span class="n">md5</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">islice</span><span class="p">,</span> <span class="n">cycle</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="nb">zip</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">RLock</span>

<span class="n">murmur3</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">cassandra.murmur3</span> <span class="k">import</span> <span class="n">murmur3</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">from</span> <span class="nn">cassandra</span> <span class="k">import</span> <span class="n">SignatureDescriptor</span><span class="p">,</span> <span class="n">ConsistencyLevel</span><span class="p">,</span> <span class="n">InvalidRequest</span><span class="p">,</span> <span class="n">Unauthorized</span>
<span class="kn">import</span> <span class="nn">cassandra.cqltypes</span> <span class="k">as</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">cassandra.encoder</span> <span class="k">import</span> <span class="n">Encoder</span>
<span class="kn">from</span> <span class="nn">cassandra.marshal</span> <span class="k">import</span> <span class="n">varint_unpack</span>
<span class="kn">from</span> <span class="nn">cassandra.protocol</span> <span class="k">import</span> <span class="n">QueryMessage</span>
<span class="kn">from</span> <span class="nn">cassandra.query</span> <span class="k">import</span> <span class="n">dict_factory</span><span class="p">,</span> <span class="n">bind_params</span>
<span class="kn">from</span> <span class="nn">cassandra.util</span> <span class="k">import</span> <span class="n">OrderedDict</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">cql_keywords</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span>
    <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;aggregate&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;allow&#39;</span><span class="p">,</span> <span class="s1">&#39;alter&#39;</span><span class="p">,</span> <span class="s1">&#39;and&#39;</span><span class="p">,</span> <span class="s1">&#39;apply&#39;</span><span class="p">,</span> <span class="s1">&#39;as&#39;</span><span class="p">,</span> <span class="s1">&#39;asc&#39;</span><span class="p">,</span> <span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;authorize&#39;</span><span class="p">,</span> <span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;begin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bigint&#39;</span><span class="p">,</span> <span class="s1">&#39;blob&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;by&#39;</span><span class="p">,</span> <span class="s1">&#39;called&#39;</span><span class="p">,</span> <span class="s1">&#39;clustering&#39;</span><span class="p">,</span> <span class="s1">&#39;columnfamily&#39;</span><span class="p">,</span> <span class="s1">&#39;compact&#39;</span><span class="p">,</span> <span class="s1">&#39;contains&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;counter&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;custom&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;decimal&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">,</span> <span class="s1">&#39;describe&#39;</span><span class="p">,</span> <span class="s1">&#39;distinct&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;drop&#39;</span><span class="p">,</span>
    <span class="s1">&#39;entries&#39;</span><span class="p">,</span> <span class="s1">&#39;execute&#39;</span><span class="p">,</span> <span class="s1">&#39;exists&#39;</span><span class="p">,</span> <span class="s1">&#39;filtering&#39;</span><span class="p">,</span> <span class="s1">&#39;finalfunc&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="s1">&#39;frozen&#39;</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="s1">&#39;function&#39;</span><span class="p">,</span>
    <span class="s1">&#39;functions&#39;</span><span class="p">,</span> <span class="s1">&#39;grant&#39;</span><span class="p">,</span> <span class="s1">&#39;if&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;inet&#39;</span><span class="p">,</span> <span class="s1">&#39;infinity&#39;</span><span class="p">,</span> <span class="s1">&#39;initcond&#39;</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;insert&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;into&#39;</span><span class="p">,</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
    <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;keys&#39;</span><span class="p">,</span> <span class="s1">&#39;keyspace&#39;</span><span class="p">,</span> <span class="s1">&#39;keyspaces&#39;</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="s1">&#39;materialized&#39;</span><span class="p">,</span> <span class="s1">&#39;modify&#39;</span><span class="p">,</span> <span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39;nologin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;norecursive&#39;</span><span class="p">,</span> <span class="s1">&#39;nosuperuser&#39;</span><span class="p">,</span> <span class="s1">&#39;not&#39;</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="s1">&#39;of&#39;</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;or&#39;</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;permission&#39;</span><span class="p">,</span>
    <span class="s1">&#39;permissions&#39;</span><span class="p">,</span> <span class="s1">&#39;primary&#39;</span><span class="p">,</span> <span class="s1">&#39;rename&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="s1">&#39;returns&#39;</span><span class="p">,</span> <span class="s1">&#39;revoke&#39;</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">,</span> <span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="s1">&#39;schema&#39;</span><span class="p">,</span> <span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sfunc&#39;</span><span class="p">,</span> <span class="s1">&#39;smallint&#39;</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;storage&#39;</span><span class="p">,</span> <span class="s1">&#39;stype&#39;</span><span class="p">,</span> <span class="s1">&#39;superuser&#39;</span><span class="p">,</span> <span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;timeuuid&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tinyint&#39;</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">,</span> <span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="s1">&#39;trigger&#39;</span><span class="p">,</span> <span class="s1">&#39;truncate&#39;</span><span class="p">,</span> <span class="s1">&#39;ttl&#39;</span><span class="p">,</span> <span class="s1">&#39;tuple&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;unlogged&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;use&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
    <span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;using&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="s1">&#39;varchar&#39;</span><span class="p">,</span> <span class="s1">&#39;varint&#39;</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;where&#39;</span><span class="p">,</span> <span class="s1">&#39;with&#39;</span><span class="p">,</span> <span class="s1">&#39;writetime&#39;</span>
<span class="p">))</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Set of keywords in CQL.</span>

<span class="sd">Derived from .../cassandra/src/java/org/apache/cassandra/cql3/Cql.g</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">cql_keywords_unreserved</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span>
    <span class="s1">&#39;aggregate&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;as&#39;</span><span class="p">,</span> <span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;bigint&#39;</span><span class="p">,</span> <span class="s1">&#39;blob&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;called&#39;</span><span class="p">,</span> <span class="s1">&#39;clustering&#39;</span><span class="p">,</span> <span class="s1">&#39;compact&#39;</span><span class="p">,</span> <span class="s1">&#39;contains&#39;</span><span class="p">,</span>
    <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;counter&#39;</span><span class="p">,</span> <span class="s1">&#39;custom&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;decimal&#39;</span><span class="p">,</span> <span class="s1">&#39;distinct&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;exists&#39;</span><span class="p">,</span> <span class="s1">&#39;filtering&#39;</span><span class="p">,</span> <span class="s1">&#39;finalfunc&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
    <span class="s1">&#39;frozen&#39;</span><span class="p">,</span> <span class="s1">&#39;function&#39;</span><span class="p">,</span> <span class="s1">&#39;functions&#39;</span><span class="p">,</span> <span class="s1">&#39;inet&#39;</span><span class="p">,</span> <span class="s1">&#39;initcond&#39;</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;keys&#39;</span><span class="p">,</span> <span class="s1">&#39;keyspaces&#39;</span><span class="p">,</span>
    <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="s1">&#39;nologin&#39;</span><span class="p">,</span> <span class="s1">&#39;nosuperuser&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;permission&#39;</span><span class="p">,</span> <span class="s1">&#39;permissions&#39;</span><span class="p">,</span>
    <span class="s1">&#39;returns&#39;</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">,</span> <span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="s1">&#39;sfunc&#39;</span><span class="p">,</span> <span class="s1">&#39;smallint&#39;</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;storage&#39;</span><span class="p">,</span> <span class="s1">&#39;stype&#39;</span><span class="p">,</span> <span class="s1">&#39;superuser&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span>
    <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;timeuuid&#39;</span><span class="p">,</span> <span class="s1">&#39;tinyint&#39;</span><span class="p">,</span> <span class="s1">&#39;trigger&#39;</span><span class="p">,</span> <span class="s1">&#39;ttl&#39;</span><span class="p">,</span> <span class="s1">&#39;tuple&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="s1">&#39;varchar&#39;</span><span class="p">,</span>
    <span class="s1">&#39;varint&#39;</span><span class="p">,</span> <span class="s1">&#39;writetime&#39;</span>
<span class="p">))</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Set of unreserved keywords in CQL.</span>

<span class="sd">Derived from .../cassandra/src/java/org/apache/cassandra/cql3/Cql.g</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">cql_keywords_reserved</span> <span class="o">=</span> <span class="n">cql_keywords</span> <span class="o">-</span> <span class="n">cql_keywords_unreserved</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Set of reserved keywords in CQL.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">_encoder</span> <span class="o">=</span> <span class="n">Encoder</span><span class="p">()</span>


<div class="viewcode-block" id="Metadata"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.Metadata">[docs]</a><span class="k">class</span> <span class="nc">Metadata</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Holds a representation of the cluster schema and topology.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cluster_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot; The string name of the cluster. &quot;&quot;&quot;</span>

    <span class="n">keyspaces</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A map from keyspace names to matching :class:`~.KeyspaceMetadata` instances.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">partitioner</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The string name of the partitioner for the cluster.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">token_map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot; A :class:`~.TokenMap` instance describing the ring topology. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hosts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hosts_lock</span> <span class="o">=</span> <span class="n">RLock</span><span class="p">()</span>

<div class="viewcode-block" id="Metadata.export_schema_as_string"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.Metadata.export_schema_as_string">[docs]</a>    <span class="k">def</span> <span class="nf">export_schema_as_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string that can be executed as a query in order to recreate</span>
<span class="sd">        the entire schema.  The string is formatted to be human readable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ks</span><span class="o">.</span><span class="n">export_as_string</span><span class="p">()</span> <span class="k">for</span> <span class="n">ks</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">target_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">change_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">server_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_host</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">host</span><span class="p">)</span><span class="o">.</span><span class="n">release_version</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">get_schema_parser</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">server_version</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_type</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rebuild_all</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">tt_lower</span> <span class="o">=</span> <span class="n">target_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parse_method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="s1">&#39;get_&#39;</span> <span class="o">+</span> <span class="n">tt_lower</span><span class="p">)</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">parse_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyspaces</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">meta</span><span class="p">:</span>
                <span class="n">update_method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_update_&#39;</span> <span class="o">+</span> <span class="n">tt_lower</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tt_lower</span> <span class="o">==</span> <span class="s1">&#39;keyspace&#39;</span> <span class="ow">and</span> <span class="n">connection</span><span class="o">.</span><span class="n">protocol_version</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="c1"># we didn&#39;t have &#39;type&#39; target in legacy protocol versions, so we need to query those too</span>
                    <span class="n">user_types</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_types_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyspaces</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_keyspace</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">user_types</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">update_method</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">drop_method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_drop_&#39;</span> <span class="o">+</span> <span class="n">tt_lower</span><span class="p">)</span>
                <span class="n">drop_method</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown schema target_type: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">target_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rebuild_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="n">current_keyspaces</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">keyspace_meta</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_all_keyspaces</span><span class="p">():</span>
            <span class="n">current_keyspaces</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keyspace_meta</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">old_keyspace_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keyspace_meta</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces</span><span class="p">[</span><span class="n">keyspace_meta</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">keyspace_meta</span>
            <span class="k">if</span> <span class="n">old_keyspace_meta</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_keyspace_updated</span><span class="p">(</span><span class="n">keyspace_meta</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_keyspace_added</span><span class="p">(</span><span class="n">keyspace_meta</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># remove not-just-added keyspaces</span>
        <span class="n">removed_keyspaces</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                             <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_keyspaces</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">meta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                              <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">current_keyspaces</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ksname</span> <span class="ow">in</span> <span class="n">removed_keyspaces</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keyspace_removed</span><span class="p">(</span><span class="n">ksname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_keyspace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspace_meta</span><span class="p">,</span> <span class="n">new_user_types</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ks_name</span> <span class="o">=</span> <span class="n">keyspace_meta</span><span class="o">.</span><span class="n">name</span>
        <span class="n">old_keyspace_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ks_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces</span><span class="p">[</span><span class="n">ks_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">keyspace_meta</span>
        <span class="k">if</span> <span class="n">old_keyspace_meta</span><span class="p">:</span>
            <span class="n">keyspace_meta</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="n">old_keyspace_meta</span><span class="o">.</span><span class="n">tables</span>
            <span class="n">keyspace_meta</span><span class="o">.</span><span class="n">user_types</span> <span class="o">=</span> <span class="n">new_user_types</span> <span class="k">if</span> <span class="n">new_user_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">old_keyspace_meta</span><span class="o">.</span><span class="n">user_types</span>
            <span class="n">keyspace_meta</span><span class="o">.</span><span class="n">indexes</span> <span class="o">=</span> <span class="n">old_keyspace_meta</span><span class="o">.</span><span class="n">indexes</span>
            <span class="n">keyspace_meta</span><span class="o">.</span><span class="n">functions</span> <span class="o">=</span> <span class="n">old_keyspace_meta</span><span class="o">.</span><span class="n">functions</span>
            <span class="n">keyspace_meta</span><span class="o">.</span><span class="n">aggregates</span> <span class="o">=</span> <span class="n">old_keyspace_meta</span><span class="o">.</span><span class="n">aggregates</span>
            <span class="n">keyspace_meta</span><span class="o">.</span><span class="n">views</span> <span class="o">=</span> <span class="n">old_keyspace_meta</span><span class="o">.</span><span class="n">views</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">keyspace_meta</span><span class="o">.</span><span class="n">replication_strategy</span> <span class="o">!=</span> <span class="n">old_keyspace_meta</span><span class="o">.</span><span class="n">replication_strategy</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_keyspace_updated</span><span class="p">(</span><span class="n">ks_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keyspace_added</span><span class="p">(</span><span class="n">ks_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_drop_keyspace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspace</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">keyspace</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keyspace_removed</span><span class="p">(</span><span class="n">keyspace</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">keyspace_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces</span><span class="p">[</span><span class="n">meta</span><span class="o">.</span><span class="n">keyspace_name</span><span class="p">]</span>
            <span class="c1"># this is unfortunate, but protocol v4 does not differentiate</span>
            <span class="c1"># between events for tables and views. &lt;parser&gt;.get_table will</span>
            <span class="c1"># return one or the other based on the query results.</span>
            <span class="c1"># Here we deal with that.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">TableMetadata</span><span class="p">):</span>
                <span class="n">keyspace_meta</span><span class="o">.</span><span class="n">_add_table_metadata</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keyspace_meta</span><span class="o">.</span><span class="n">_add_view_metadata</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># can happen if keyspace disappears while processing async event</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_drop_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspace</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">keyspace_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces</span><span class="p">[</span><span class="n">keyspace</span><span class="p">]</span>
            <span class="n">keyspace_meta</span><span class="o">.</span><span class="n">_drop_table_metadata</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>  <span class="c1"># handles either table or view</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># can happen if keyspace disappears while processing async event</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_update_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_meta</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces</span><span class="p">[</span><span class="n">type_meta</span><span class="o">.</span><span class="n">keyspace</span><span class="p">]</span><span class="o">.</span><span class="n">user_types</span><span class="p">[</span><span class="n">type_meta</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_meta</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># can happen if keyspace disappears while processing async event</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_drop_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspace</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces</span><span class="p">[</span><span class="n">keyspace</span><span class="p">]</span><span class="o">.</span><span class="n">user_types</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># can happen if keyspace disappears while processing async event</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_update_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_meta</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces</span><span class="p">[</span><span class="n">function_meta</span><span class="o">.</span><span class="n">keyspace</span><span class="p">]</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="n">function_meta</span><span class="o">.</span><span class="n">signature</span><span class="p">]</span> <span class="o">=</span> <span class="n">function_meta</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># can happen if keyspace disappears while processing async event</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_drop_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspace</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces</span><span class="p">[</span><span class="n">keyspace</span><span class="p">]</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_update_aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate_meta</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces</span><span class="p">[</span><span class="n">aggregate_meta</span><span class="o">.</span><span class="n">keyspace</span><span class="p">]</span><span class="o">.</span><span class="n">aggregates</span><span class="p">[</span><span class="n">aggregate_meta</span><span class="o">.</span><span class="n">signature</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggregate_meta</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_drop_aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspace</span><span class="p">,</span> <span class="n">aggregate</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces</span><span class="p">[</span><span class="n">keyspace</span><span class="p">]</span><span class="o">.</span><span class="n">aggregates</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">aggregate</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_keyspace_added</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ksname</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_map</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">token_map</span><span class="o">.</span><span class="n">rebuild_keyspace</span><span class="p">(</span><span class="n">ksname</span><span class="p">,</span> <span class="n">build_if_absent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_keyspace_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ksname</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_map</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">token_map</span><span class="o">.</span><span class="n">rebuild_keyspace</span><span class="p">(</span><span class="n">ksname</span><span class="p">,</span> <span class="n">build_if_absent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_keyspace_removed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ksname</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_map</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">token_map</span><span class="o">.</span><span class="n">remove_keyspace</span><span class="p">(</span><span class="n">ksname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rebuild_token_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partitioner</span><span class="p">,</span> <span class="n">token_map</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rebuild our view of the topology from fresh rows from the</span>
<span class="sd">        system topology tables.</span>
<span class="sd">        For internal use only.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partitioner</span> <span class="o">=</span> <span class="n">partitioner</span>
        <span class="k">if</span> <span class="n">partitioner</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;RandomPartitioner&#39;</span><span class="p">):</span>
            <span class="n">token_class</span> <span class="o">=</span> <span class="n">MD5Token</span>
        <span class="k">elif</span> <span class="n">partitioner</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Murmur3Partitioner&#39;</span><span class="p">):</span>
            <span class="n">token_class</span> <span class="o">=</span> <span class="n">Murmur3Token</span>
        <span class="k">elif</span> <span class="n">partitioner</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;ByteOrderedPartitioner&#39;</span><span class="p">):</span>
            <span class="n">token_class</span> <span class="o">=</span> <span class="n">BytesToken</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">token_map</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>

        <span class="n">token_to_host_owner</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ring</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">host</span><span class="p">,</span> <span class="n">token_strings</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">token_map</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">token_string</span> <span class="ow">in</span> <span class="n">token_strings</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">token_class</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">token_string</span><span class="p">)</span>
                <span class="n">ring</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="n">token_to_host_owner</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="n">host</span>

        <span class="n">all_tokens</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_map</span> <span class="o">=</span> <span class="n">TokenMap</span><span class="p">(</span>
            <span class="n">token_class</span><span class="p">,</span> <span class="n">token_to_host_owner</span><span class="p">,</span> <span class="n">all_tokens</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Metadata.get_replicas"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.Metadata.get_replicas">[docs]</a>    <span class="k">def</span> <span class="nf">get_replicas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspace</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of :class:`.Host` instances that are replicas for a given</span>
<span class="sd">        partition key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_map</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">get_replicas</span><span class="p">(</span><span class="n">keyspace</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">token_class</span><span class="o">.</span><span class="n">from_key</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">NoMurmur3</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span></div>

    <span class="k">def</span> <span class="nf">can_support_partitioner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">partitioner</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Murmur3Partitioner&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">murmur3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="Metadata.add_or_return_host"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.Metadata.add_or_return_host">[docs]</a>    <span class="k">def</span> <span class="nf">add_or_return_host</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a tuple (host, new), where ``host`` is a Host</span>
<span class="sd">        instance, and ``new`` is a bool indicating whether</span>
<span class="sd">        the host was newly added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hosts_lock</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hosts</span><span class="p">[</span><span class="n">host</span><span class="o">.</span><span class="n">address</span><span class="p">],</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_hosts</span><span class="p">[</span><span class="n">host</span><span class="o">.</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="n">host</span>
                <span class="k">return</span> <span class="n">host</span><span class="p">,</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">remove_host</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hosts_lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hosts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_host</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hosts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>

<div class="viewcode-block" id="Metadata.all_hosts"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.Metadata.all_hosts">[docs]</a>    <span class="k">def</span> <span class="nf">all_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of all known :class:`.Host` instances in the cluster.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hosts_lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hosts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div></div>


<span class="n">REPLICATION_STRATEGY_CLASS_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;org.apache.cassandra.locator.&quot;</span>


<span class="k">def</span> <span class="nf">trim_if_startswith</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="n">_replication_strategies</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">class</span> <span class="nc">ReplicationStrategyTypeType</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">metacls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>
        <span class="n">dct</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">metacls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
            <span class="n">_replication_strategies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span>
        <span class="k">return</span> <span class="bp">cls</span>


<span class="nd">@six</span><span class="o">.</span><span class="n">add_metaclass</span><span class="p">(</span><span class="n">ReplicationStrategyTypeType</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_ReplicationStrategy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">options_map</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">strategy_class</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">strategy_class</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">strategy_name</span> <span class="o">=</span> <span class="n">trim_if_startswith</span><span class="p">(</span><span class="n">strategy_class</span><span class="p">,</span> <span class="n">REPLICATION_STRATEGY_CLASS_PREFIX</span><span class="p">)</span>

        <span class="n">rs_class</span> <span class="o">=</span> <span class="n">_replication_strategies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">strategy_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rs_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rs_class</span> <span class="o">=</span> <span class="n">_UnknownStrategyBuilder</span><span class="p">(</span><span class="n">strategy_name</span><span class="p">)</span>
            <span class="n">_replication_strategies</span><span class="p">[</span><span class="n">strategy_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rs_class</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">rs_instance</span> <span class="o">=</span> <span class="n">rs_class</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed creating </span><span class="si">%s</span><span class="s2"> with options </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">rs_instance</span>

    <span class="k">def</span> <span class="nf">make_token_replica_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_to_host_owner</span><span class="p">,</span> <span class="n">ring</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">export_for_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>


<span class="n">ReplicationStrategy</span> <span class="o">=</span> <span class="n">_ReplicationStrategy</span>


<span class="k">class</span> <span class="nc">_UnknownStrategyBuilder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
        <span class="n">strategy_instance</span> <span class="o">=</span> <span class="n">_UnknownStrategy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">strategy_instance</span>


<span class="k">class</span> <span class="nc">_UnknownStrategy</span><span class="p">(</span><span class="n">ReplicationStrategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options_map</span> <span class="o">=</span> <span class="n">options_map</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">options_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options_map</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">_UnknownStrategy</span><span class="p">)</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_map</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">options_map</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">export_for_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string version of these replication options which are</span>
<span class="sd">        suitable for use in a CREATE KEYSPACE statement.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_map</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_map</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">return</span> <span class="s2">&quot;{&#39;class&#39;: &#39;</span><span class="si">%s</span><span class="s2">&#39;}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_token_replica_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_to_host_owner</span><span class="p">,</span> <span class="n">ring</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>


<div class="viewcode-block" id="SimpleStrategy"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.SimpleStrategy">[docs]</a><span class="k">class</span> <span class="nc">SimpleStrategy</span><span class="p">(</span><span class="n">ReplicationStrategy</span><span class="p">):</span>

    <span class="n">replication_factor</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The replication factor for this keyspace.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">replication_factor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">options_map</span><span class="p">[</span><span class="s1">&#39;replication_factor&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;SimpleStrategy requires an integer &#39;replication_factor&#39; option&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_token_replica_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_to_host_owner</span><span class="p">,</span> <span class="n">ring</span><span class="p">):</span>
        <span class="n">replica_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">)):</span>
            <span class="n">j</span><span class="p">,</span> <span class="n">hosts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">hosts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">replication_factor</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">):</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">ring</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">)]</span>
                <span class="n">host</span> <span class="o">=</span> <span class="n">token_to_host_owner</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">host</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hosts</span><span class="p">:</span>
                    <span class="n">hosts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">replica_map</span><span class="p">[</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">hosts</span>
        <span class="k">return</span> <span class="n">replica_map</span>

<div class="viewcode-block" id="SimpleStrategy.export_for_schema"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.SimpleStrategy.export_for_schema">[docs]</a>    <span class="k">def</span> <span class="nf">export_for_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string version of these replication options which are</span>
<span class="sd">        suitable for use in a CREATE KEYSPACE statement.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;{&#39;class&#39;: &#39;SimpleStrategy&#39;, &#39;replication_factor&#39;: &#39;</span><span class="si">%d</span><span class="s2">&#39;}&quot;</span> \
               <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">replication_factor</span><span class="p">,)</span></div>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">SimpleStrategy</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">replication_factor</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">replication_factor</span></div>


<div class="viewcode-block" id="NetworkTopologyStrategy"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.NetworkTopologyStrategy">[docs]</a><span class="k">class</span> <span class="nc">NetworkTopologyStrategy</span><span class="p">(</span><span class="n">ReplicationStrategy</span><span class="p">):</span>

    <span class="n">dc_replication_factors</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A map of datacenter names to the replication factor for that DC.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dc_replication_factors</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dc_replication_factors</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dc_replication_factors</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">make_token_replica_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_to_host_owner</span><span class="p">,</span> <span class="n">ring</span><span class="p">):</span>
        <span class="n">dc_rf_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">dc</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">rf</span><span class="p">))</span>
                         <span class="k">for</span> <span class="n">dc</span><span class="p">,</span> <span class="n">rf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc_replication_factors</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">rf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># build a map of DCs to lists of indexes into `ring` for tokens that</span>
        <span class="c1"># belong to that DC</span>
        <span class="n">dc_to_token_offset</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">dc_racks</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="n">hosts_per_dc</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ring</span><span class="p">):</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">token_to_host_owner</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>
            <span class="n">dc_to_token_offset</span><span class="p">[</span><span class="n">host</span><span class="o">.</span><span class="n">datacenter</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">host</span><span class="o">.</span><span class="n">datacenter</span> <span class="ow">and</span> <span class="n">host</span><span class="o">.</span><span class="n">rack</span><span class="p">:</span>
                <span class="n">dc_racks</span><span class="p">[</span><span class="n">host</span><span class="o">.</span><span class="n">datacenter</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">rack</span><span class="p">)</span>
                <span class="n">hosts_per_dc</span><span class="p">[</span><span class="n">host</span><span class="o">.</span><span class="n">datacenter</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>

        <span class="c1"># A map of DCs to an index into the dc_to_token_offset value for that dc.</span>
        <span class="c1"># This is how we keep track of advancing around the ring for each DC.</span>
        <span class="n">dc_to_current_index</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">replica_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">)):</span>
            <span class="n">replicas</span> <span class="o">=</span> <span class="n">replica_map</span><span class="p">[</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

            <span class="c1"># go through each DC and find the replicas in that DC</span>
            <span class="k">for</span> <span class="n">dc</span> <span class="ow">in</span> <span class="n">dc_to_token_offset</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">dc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dc_rf_map</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># advance our per-DC index until we&#39;re up to at least the</span>
                <span class="c1"># current token in the ring</span>
                <span class="n">token_offsets</span> <span class="o">=</span> <span class="n">dc_to_token_offset</span><span class="p">[</span><span class="n">dc</span><span class="p">]</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">dc_to_current_index</span><span class="p">[</span><span class="n">dc</span><span class="p">]</span>
                <span class="n">num_tokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_offsets</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">num_tokens</span> <span class="ow">and</span> <span class="n">token_offsets</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">dc_to_current_index</span><span class="p">[</span><span class="n">dc</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>

                <span class="n">replicas_remaining</span> <span class="o">=</span> <span class="n">dc_rf_map</span><span class="p">[</span><span class="n">dc</span><span class="p">]</span>
                <span class="n">replicas_this_dc</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">skipped_hosts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">racks_placed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">racks_this_dc</span> <span class="o">=</span> <span class="n">dc_racks</span><span class="p">[</span><span class="n">dc</span><span class="p">]</span>
                <span class="n">hosts_this_dc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hosts_per_dc</span><span class="p">[</span><span class="n">dc</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">token_offset</span> <span class="ow">in</span> <span class="n">islice</span><span class="p">(</span><span class="n">cycle</span><span class="p">(</span><span class="n">token_offsets</span><span class="p">),</span> <span class="n">index</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="n">num_tokens</span><span class="p">):</span>
                    <span class="n">host</span> <span class="o">=</span> <span class="n">token_to_host_owner</span><span class="p">[</span><span class="n">ring</span><span class="p">[</span><span class="n">token_offset</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="n">replicas_remaining</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">replicas_this_dc</span> <span class="o">==</span> <span class="n">hosts_this_dc</span><span class="p">:</span>
                        <span class="k">break</span>

                    <span class="k">if</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">replicas</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">host</span><span class="o">.</span><span class="n">rack</span> <span class="ow">in</span> <span class="n">racks_placed</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">racks_placed</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">racks_this_dc</span><span class="p">):</span>
                        <span class="n">skipped_hosts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="n">replicas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
                    <span class="n">replicas_this_dc</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">replicas_remaining</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">racks_placed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">rack</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">racks_placed</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">racks_this_dc</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">skipped_hosts</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">replicas_remaining</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="n">replicas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
                            <span class="n">replicas_remaining</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="k">del</span> <span class="n">skipped_hosts</span><span class="p">[:]</span>

        <span class="k">return</span> <span class="n">replica_map</span>

<div class="viewcode-block" id="NetworkTopologyStrategy.export_for_schema"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.NetworkTopologyStrategy.export_for_schema">[docs]</a>    <span class="k">def</span> <span class="nf">export_for_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string version of these replication options which are</span>
<span class="sd">        suitable for use in a CREATE KEYSPACE statement.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;{&#39;class&#39;: &#39;NetworkTopologyStrategy&#39;&quot;</span>
        <span class="k">for</span> <span class="n">dc</span><span class="p">,</span> <span class="n">repl_factor</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dc_replication_factors</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;, &#39;</span><span class="si">%s</span><span class="s2">&#39;: &#39;</span><span class="si">%d</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">repl_factor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span></div>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">NetworkTopologyStrategy</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc_replication_factors</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dc_replication_factors</span></div>


<div class="viewcode-block" id="LocalStrategy"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.LocalStrategy">[docs]</a><span class="k">class</span> <span class="nc">LocalStrategy</span><span class="p">(</span><span class="n">ReplicationStrategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">make_token_replica_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_to_host_owner</span><span class="p">,</span> <span class="n">ring</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

<div class="viewcode-block" id="LocalStrategy.export_for_schema"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.LocalStrategy.export_for_schema">[docs]</a>    <span class="k">def</span> <span class="nf">export_for_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string version of these replication options which are</span>
<span class="sd">        suitable for use in a CREATE KEYSPACE statement.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;{&#39;class&#39;: &#39;LocalStrategy&#39;}&quot;</span></div>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">LocalStrategy</span><span class="p">)</span></div>


<div class="viewcode-block" id="KeyspaceMetadata"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.KeyspaceMetadata">[docs]</a><span class="k">class</span> <span class="nc">KeyspaceMetadata</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A representation of the schema for a single keyspace.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot; The string name of the keyspace. &quot;&quot;&quot;</span>

    <span class="n">durable_writes</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A boolean indicating whether durable writes are enabled for this keyspace</span>
<span class="sd">    or not.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">replication_strategy</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A :class:`.ReplicationStrategy` subclass object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tables</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A map from table names to instances of :class:`~.TableMetadata`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">indexes</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dict mapping index names to :class:`.IndexMetadata` instances.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">user_types</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A map from user-defined type names to instances of :class:`~cassandra.metadata.UserType`.</span>

<span class="sd">    .. versionadded:: 2.1.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">functions</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A map from user-defined function signatures to instances of :class:`~cassandra.metadata.Function`.</span>

<span class="sd">    .. versionadded:: 2.6.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">aggregates</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A map from user-defined aggregate signatures to instances of :class:`~cassandra.metadata.Aggregate`.</span>

<span class="sd">    .. versionadded:: 2.6.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">views</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dict mapping view names to :class:`.MaterializedViewMetadata` instances.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_exc_info</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot; set if metadata parsing failed &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">durable_writes</span><span class="p">,</span> <span class="n">strategy_class</span><span class="p">,</span> <span class="n">strategy_options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">durable_writes</span> <span class="o">=</span> <span class="n">durable_writes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replication_strategy</span> <span class="o">=</span> <span class="n">ReplicationStrategy</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">strategy_class</span><span class="p">,</span> <span class="n">strategy_options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">views</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="KeyspaceMetadata.export_as_string"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.KeyspaceMetadata.export_as_string">[docs]</a>    <span class="k">def</span> <span class="nf">export_as_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a CQL query string that can be used to recreate the entire keyspace,</span>
<span class="sd">        including user-defined types and tables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cql</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">as_cql_query</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span><span class="p">]</span>
                         <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_type_strings</span><span class="p">()</span>
                         <span class="o">+</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">export_as_string</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                         <span class="o">+</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">export_as_string</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregates</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                         <span class="o">+</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">export_as_string</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exc_info</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">traceback</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;/*</span><span class="se">\n</span><span class="s2">Warning: Keyspace </span><span class="si">%s</span><span class="s2"> is incomplete because of an error processing metadata.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> \
                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_exc_info</span><span class="p">):</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="n">line</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Approximate structure, for reference:</span><span class="se">\n</span><span class="s2">(this should not be used to reproduce this schema)</span><span class="se">\n\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">*/&quot;</span> <span class="o">%</span> <span class="n">cql</span>
            <span class="k">return</span> <span class="n">ret</span>
        <span class="k">return</span> <span class="n">cql</span></div>

<div class="viewcode-block" id="KeyspaceMetadata.as_cql_query"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.KeyspaceMetadata.as_cql_query">[docs]</a>    <span class="k">def</span> <span class="nf">as_cql_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a CQL query string that can be used to recreate just this keyspace,</span>
<span class="sd">        not including user-defined types and tables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;CREATE KEYSPACE </span><span class="si">%s</span><span class="s2"> WITH replication = </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">replication_strategy</span><span class="o">.</span><span class="n">export_for_schema</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">ret</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39; AND durable_writes = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;true&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">durable_writes</span> <span class="k">else</span> <span class="s2">&quot;false&quot;</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">user_type_strings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user_type_strings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">user_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_types</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">user_types</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">user_types</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resolve_user_types</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">user_types</span><span class="p">,</span> <span class="n">user_type_strings</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user_type_strings</span>

    <span class="k">def</span> <span class="nf">resolve_user_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">user_types</span><span class="p">,</span> <span class="n">user_type_strings</span><span class="p">):</span>
        <span class="n">user_type</span> <span class="o">=</span> <span class="n">user_types</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">type_name</span> <span class="ow">in</span> <span class="n">user_type</span><span class="o">.</span><span class="n">field_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sub_type</span> <span class="ow">in</span> <span class="n">types</span><span class="o">.</span><span class="n">cql_types_from_string</span><span class="p">(</span><span class="n">type_name</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sub_type</span> <span class="ow">in</span> <span class="n">user_types</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resolve_user_types</span><span class="p">(</span><span class="n">sub_type</span><span class="p">,</span> <span class="n">user_types</span><span class="p">,</span> <span class="n">user_type_strings</span><span class="p">)</span>
        <span class="n">user_type_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_type</span><span class="o">.</span><span class="n">export_as_string</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_add_table_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_metadata</span><span class="p">):</span>
        <span class="n">old_indexes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">old_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">table_metadata</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">old_meta</span><span class="p">:</span>
            <span class="c1"># views are not queried with table, so they must be transferred to new</span>
            <span class="n">table_metadata</span><span class="o">.</span><span class="n">views</span> <span class="o">=</span> <span class="n">old_meta</span><span class="o">.</span><span class="n">views</span>
            <span class="c1"># indexes will be updated with what is on the new metadata</span>
            <span class="n">old_indexes</span> <span class="o">=</span> <span class="n">old_meta</span><span class="o">.</span><span class="n">indexes</span>

        <span class="c1"># note the intentional order of add before remove</span>
        <span class="c1"># this makes sure the maps are never absent something that existed before this update</span>
        <span class="k">for</span> <span class="n">index_name</span><span class="p">,</span> <span class="n">index_metadata</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">table_metadata</span><span class="o">.</span><span class="n">indexes</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_metadata</span>

        <span class="k">for</span> <span class="n">index_name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">old_indexes</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_metadata</span><span class="o">.</span><span class="n">indexes</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">table_metadata</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_metadata</span>

    <span class="k">def</span> <span class="nf">_drop_table_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
        <span class="n">table_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">table_meta</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index_name</span> <span class="ow">in</span> <span class="n">table_meta</span><span class="o">.</span><span class="n">indexes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">view_name</span> <span class="ow">in</span> <span class="n">table_meta</span><span class="o">.</span><span class="n">views</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">view_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># we can&#39;t tell table drops from views, so drop both</span>
        <span class="c1"># (name is unique among them, within a keyspace)</span>
        <span class="n">view_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">view_meta</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">view_meta</span><span class="o">.</span><span class="n">base_table_name</span><span class="p">]</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_add_view_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_metadata</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">view_metadata</span><span class="o">.</span><span class="n">base_table_name</span><span class="p">]</span><span class="o">.</span><span class="n">views</span><span class="p">[</span><span class="n">view_metadata</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">view_metadata</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">[</span><span class="n">view_metadata</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">view_metadata</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="UserType"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.UserType">[docs]</a><span class="k">class</span> <span class="nc">UserType</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A user defined type, as created by ``CREATE TYPE`` statements.</span>

<span class="sd">    User-defined types were introduced in Cassandra 2.1.</span>

<span class="sd">    .. versionadded:: 2.1.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">keyspace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The string name of the keyspace in which this type is defined.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The name of this type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">field_names</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An ordered list of the names for each field in this user-defined type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">field_types</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An ordered list of the types for each field in this user-defined type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspace</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">field_types</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyspace</span> <span class="o">=</span> <span class="n">keyspace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="c1"># non-frozen collections can return None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_names</span> <span class="o">=</span> <span class="n">field_names</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_types</span> <span class="o">=</span> <span class="n">field_types</span> <span class="ow">or</span> <span class="p">[]</span>

<div class="viewcode-block" id="UserType.as_cql_query"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.UserType.as_cql_query">[docs]</a>    <span class="k">def</span> <span class="nf">as_cql_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formatted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a CQL query that can be used to recreate this type.</span>
<span class="sd">        If `formatted` is set to :const:`True`, extra whitespace will</span>
<span class="sd">        be added to make the query more readable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;CREATE TYPE </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyspace</span><span class="p">),</span>
            <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">formatted</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">formatted</span><span class="p">:</span>
            <span class="n">field_join</span> <span class="o">=</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="s2">&quot;    &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field_join</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_type</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_types</span><span class="p">):</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">protect_name</span><span class="p">(</span><span class="n">field_name</span><span class="p">),</span> <span class="n">field_type</span><span class="p">))</span>

        <span class="n">ret</span> <span class="o">+=</span> <span class="n">field_join</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">padding</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">)&quot;</span> <span class="k">if</span> <span class="n">formatted</span> <span class="k">else</span> <span class="s2">&quot;)&quot;</span>
        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="k">def</span> <span class="nf">export_as_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_cql_query</span><span class="p">(</span><span class="n">formatted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span></div>


<div class="viewcode-block" id="Aggregate"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.Aggregate">[docs]</a><span class="k">class</span> <span class="nc">Aggregate</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A user defined aggregate function, as created by ``CREATE AGGREGATE`` statements.</span>

<span class="sd">    Aggregate functions were introduced in Cassandra 2.2</span>

<span class="sd">    .. versionadded:: 2.6.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">keyspace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The string name of the keyspace in which this aggregate is defined</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The name of this aggregate</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">argument_types</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An ordered list of the types for each argument to the aggregate</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">final_func</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Name of a final function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">initial_condition</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initial condition of the aggregate</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">return_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return type of the aggregate</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">state_func</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Name of a state function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">state_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Type of the aggregate state</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspace</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">argument_types</span><span class="p">,</span> <span class="n">state_func</span><span class="p">,</span>
                 <span class="n">state_type</span><span class="p">,</span> <span class="n">final_func</span><span class="p">,</span> <span class="n">initial_condition</span><span class="p">,</span> <span class="n">return_type</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyspace</span> <span class="o">=</span> <span class="n">keyspace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">argument_types</span> <span class="o">=</span> <span class="n">argument_types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_func</span> <span class="o">=</span> <span class="n">state_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_type</span> <span class="o">=</span> <span class="n">state_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_func</span> <span class="o">=</span> <span class="n">final_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_condition</span> <span class="o">=</span> <span class="n">initial_condition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_type</span> <span class="o">=</span> <span class="n">return_type</span>

<div class="viewcode-block" id="Aggregate.as_cql_query"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.Aggregate.as_cql_query">[docs]</a>    <span class="k">def</span> <span class="nf">as_cql_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formatted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a CQL query that can be used to recreate this aggregate.</span>
<span class="sd">        If `formatted` is set to :const:`True`, extra whitespace will</span>
<span class="sd">        be added to make the query more readable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    &#39;</span> <span class="k">if</span> <span class="n">formatted</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span>
        <span class="n">keyspace</span> <span class="o">=</span> <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyspace</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">type_list</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">argument_types</span><span class="p">)</span>
        <span class="n">state_func</span> <span class="o">=</span> <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_func</span><span class="p">)</span>
        <span class="n">state_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_type</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;CREATE AGGREGATE </span><span class="si">%(keyspace)s</span><span class="s2">.</span><span class="si">%(name)s</span><span class="s2">(</span><span class="si">%(type_list)s</span><span class="s2">)</span><span class="si">%(sep)s</span><span class="s2">&quot;</span> \
              <span class="s2">&quot;SFUNC </span><span class="si">%(state_func)s%(sep)s</span><span class="s2">&quot;</span> \
              <span class="s2">&quot;STYPE </span><span class="si">%(state_type)s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">locals</span><span class="p">()</span>

        <span class="n">ret</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">sep</span><span class="p">,</span> <span class="s1">&#39;FINALFUNC &#39;</span><span class="p">,</span> <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_func</span><span class="p">)))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_func</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">sep</span><span class="p">,</span> <span class="s1">&#39;INITCOND &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_condition</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_condition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="k">def</span> <span class="nf">export_as_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_cql_query</span><span class="p">(</span><span class="n">formatted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">signature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SignatureDescriptor</span><span class="o">.</span><span class="n">format_signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">argument_types</span><span class="p">)</span></div>


<div class="viewcode-block" id="Function"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.Function">[docs]</a><span class="k">class</span> <span class="nc">Function</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A user defined function, as created by ``CREATE FUNCTION`` statements.</span>

<span class="sd">    User-defined functions were introduced in Cassandra 2.2</span>

<span class="sd">    .. versionadded:: 2.6.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">keyspace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The string name of the keyspace in which this function is defined</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The name of this function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">argument_types</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An ordered list of the types for each argument to the function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">argument_names</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An ordered list of the names of each argument to the function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">return_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return type of the function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">language</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Language of the function body</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">body</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function body string</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">called_on_null_input</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flag indicating whether this function should be called for rows with null values</span>
<span class="sd">    (convenience function to avoid handling nulls explicitly if the result will just be null)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspace</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">argument_types</span><span class="p">,</span> <span class="n">argument_names</span><span class="p">,</span>
                 <span class="n">return_type</span><span class="p">,</span> <span class="n">language</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">called_on_null_input</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyspace</span> <span class="o">=</span> <span class="n">keyspace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">argument_types</span> <span class="o">=</span> <span class="n">argument_types</span>
        <span class="c1"># argument_types (frozen&lt;list&lt;&gt;&gt;) will always be a list</span>
        <span class="c1"># argument_name is not frozen in C* &lt; 3.0 and may return None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">argument_names</span> <span class="o">=</span> <span class="n">argument_names</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_type</span> <span class="o">=</span> <span class="n">return_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">language</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">called_on_null_input</span> <span class="o">=</span> <span class="n">called_on_null_input</span>

<div class="viewcode-block" id="Function.as_cql_query"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.Function.as_cql_query">[docs]</a>    <span class="k">def</span> <span class="nf">as_cql_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formatted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a CQL query that can be used to recreate this function.</span>
<span class="sd">        If `formatted` is set to :const:`True`, extra whitespace will</span>
<span class="sd">        be added to make the query more readable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    &#39;</span> <span class="k">if</span> <span class="n">formatted</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span>
        <span class="n">keyspace</span> <span class="o">=</span> <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyspace</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">arg_list</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">protect_name</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">t</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">argument_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">argument_types</span><span class="p">)])</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_type</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">language</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span>
        <span class="n">on_null</span> <span class="o">=</span> <span class="s2">&quot;CALLED&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">called_on_null_input</span> <span class="k">else</span> <span class="s2">&quot;RETURNS NULL&quot;</span>

        <span class="k">return</span> <span class="s2">&quot;CREATE FUNCTION </span><span class="si">%(keyspace)s</span><span class="s2">.</span><span class="si">%(name)s</span><span class="s2">(</span><span class="si">%(arg_list)s</span><span class="s2">)</span><span class="si">%(sep)s</span><span class="s2">&quot;</span> \
               <span class="s2">&quot;</span><span class="si">%(on_null)s</span><span class="s2"> ON NULL INPUT</span><span class="si">%(sep)s</span><span class="s2">&quot;</span> \
               <span class="s2">&quot;RETURNS </span><span class="si">%(typ)s%(sep)s</span><span class="s2">&quot;</span> \
               <span class="s2">&quot;LANGUAGE </span><span class="si">%(lang)s%(sep)s</span><span class="s2">&quot;</span> \
               <span class="s2">&quot;AS $$</span><span class="si">%(body)s</span><span class="s2">$$&quot;</span> <span class="o">%</span> <span class="nb">locals</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">export_as_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_cql_query</span><span class="p">(</span><span class="n">formatted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">signature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SignatureDescriptor</span><span class="o">.</span><span class="n">format_signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">argument_types</span><span class="p">)</span></div>


<div class="viewcode-block" id="TableMetadata"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.TableMetadata">[docs]</a><span class="k">class</span> <span class="nc">TableMetadata</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A representation of the schema for a single table.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">keyspace_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot; String name of this Table&#39;s keyspace &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot; The string name of the table. &quot;&quot;&quot;</span>

    <span class="n">partition_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A list of :class:`.ColumnMetadata` instances representing the columns in</span>
<span class="sd">    the partition key for this table.  This will always hold at least one</span>
<span class="sd">    column.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">clustering_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A list of :class:`.ColumnMetadata` instances representing the columns</span>
<span class="sd">    in the clustering key for this table.  These are all of the</span>
<span class="sd">    :attr:`.primary_key` columns that are not in the :attr:`.partition_key`.</span>

<span class="sd">    Note that a table may have no clustering keys, in which case this will</span>
<span class="sd">    be an empty list.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">primary_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A list of :class:`.ColumnMetadata` representing the components of</span>
<span class="sd">        the primary key for this table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition_key</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_key</span>

    <span class="n">columns</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dict mapping column names to :class:`.ColumnMetadata` instances.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">indexes</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dict mapping index names to :class:`.IndexMetadata` instances.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">is_compact_storage</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">options</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dict mapping table option names to their specific settings for this</span>
<span class="sd">    table.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">compaction_options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;min_compaction_threshold&quot;</span><span class="p">:</span> <span class="s2">&quot;min_threshold&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max_compaction_threshold&quot;</span><span class="p">:</span> <span class="s2">&quot;max_threshold&quot;</span><span class="p">,</span>
        <span class="s2">&quot;compaction_strategy_class&quot;</span><span class="p">:</span> <span class="s2">&quot;class&quot;</span><span class="p">}</span>

    <span class="n">triggers</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dict mapping trigger names to :class:`.TriggerMetadata` instances.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">views</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dict mapping view names to :class:`.MaterializedViewMetadata` instances.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_exc_info</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot; set if metadata parsing failed &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_cql_compatible</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A boolean indicating if this table can be represented as CQL in export</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">comparator</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;comparator&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comparator</span><span class="p">:</span>
            <span class="c1"># no compact storage with more than one column beyond PK if there</span>
            <span class="c1"># are clustering columns</span>
            <span class="n">incompatible</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_compact_storage</span> <span class="ow">and</span>
                            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">and</span>
                            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clustering_key</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">return</span> <span class="ow">not</span> <span class="n">incompatible</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="n">extensions</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Metadata describing configuration for table extensions</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspace_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">partition_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clustering_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_name</span> <span class="o">=</span> <span class="n">keyspace_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partition_key</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">partition_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">partition_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_key</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">clustering_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">clustering_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span> <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comparator</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span> <span class="k">if</span> <span class="n">triggers</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">triggers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">views</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="TableMetadata.export_as_string"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.TableMetadata.export_as_string">[docs]</a>    <span class="k">def</span> <span class="nf">export_as_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string of CQL queries that can be used to recreate this table</span>
<span class="sd">        along with all indexes on it.  The returned string is formatted to</span>
<span class="sd">        be human readable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exc_info</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">traceback</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;/*</span><span class="se">\n</span><span class="s2">Warning: Table </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2"> is incomplete because of an error processing metadata.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> \
                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyspace_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_exc_info</span><span class="p">):</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="n">line</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Approximate structure, for reference:</span><span class="se">\n</span><span class="s2">(this should not be used to reproduce this schema)</span><span class="se">\n\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">*/&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_as_cql</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_cql_compatible</span><span class="p">:</span>
            <span class="c1"># If we can&#39;t produce this table with CQL, comment inline</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;/*</span><span class="se">\n</span><span class="s2">Warning: Table </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2"> omitted because it has constructs not compatible with CQL (was created via legacy API).</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> \
                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyspace_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Approximate structure, for reference:</span><span class="se">\n</span><span class="s2">(this should not be used to reproduce this schema)</span><span class="se">\n\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">*/&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_as_cql</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_as_cql</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="k">def</span> <span class="nf">_all_as_cql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_cql_query</span><span class="p">(</span><span class="n">formatted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;;&quot;</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">;&quot;</span> <span class="o">%</span> <span class="n">index</span><span class="o">.</span><span class="n">as_cql_query</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">trigger_meta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trigger_meta</span><span class="o">.</span><span class="n">as_cql_query</span><span class="p">(),)</span>

        <span class="k">for</span> <span class="n">view_meta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">%s</span><span class="s2">;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">view_meta</span><span class="o">.</span><span class="n">as_cql_query</span><span class="p">(</span><span class="n">formatted</span><span class="o">=</span><span class="kc">True</span><span class="p">),)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span><span class="p">:</span>
            <span class="n">registry</span> <span class="o">=</span> <span class="n">_RegisteredExtensionType</span><span class="o">.</span><span class="n">_extension_registry</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">viewkeys</span><span class="p">(</span><span class="n">registry</span><span class="p">)</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span><span class="p">:</span>  <span class="c1"># no viewkeys on OrderedMapSerializeKey</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="n">registry</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">cql</span> <span class="o">=</span> <span class="n">ext</span><span class="o">.</span><span class="n">after_table_cql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">cql</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cql</span><span class="p">,)</span>

        <span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="TableMetadata.as_cql_query"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.TableMetadata.as_cql_query">[docs]</a>    <span class="k">def</span> <span class="nf">as_cql_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formatted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a CQL query that can be used to recreate this table (index</span>
<span class="sd">        creations are not included).  If `formatted` is set to :const:`True`,</span>
<span class="sd">        extra whitespace will be added to make the query human readable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;CREATE TABLE </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyspace_name</span><span class="p">),</span>
            <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">formatted</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">formatted</span><span class="p">:</span>
            <span class="n">column_join</span> <span class="o">=</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="s2">&quot;    &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">column_join</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">protect_name</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">col</span><span class="o">.</span><span class="n">cql_type</span><span class="p">,</span> <span class="s1">&#39; static&#39;</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">is_static</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">partition_key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_key</span><span class="p">:</span>
            <span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot; PRIMARY KEY&quot;</span>

        <span class="n">ret</span> <span class="o">+=</span> <span class="n">column_join</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">padding</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">)</span>

        <span class="c1"># primary key</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">partition_key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_key</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">PRIMARY KEY (&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">column_join</span><span class="p">,</span> <span class="n">padding</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">partition_key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">protect_name</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition_key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">partition_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_key</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">protect_name</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_key</span><span class="p">)</span>

            <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;)&quot;</span>

        <span class="c1"># properties</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">) WITH &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">formatted</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_property_string</span><span class="p">(</span><span class="n">formatted</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_compact_storage</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_property_string</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">formatted</span><span class="p">,</span> <span class="n">clustering_key</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">is_compact_storage</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">is_compact_storage</span><span class="p">:</span>
            <span class="n">properties</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;COMPACT STORAGE&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">clustering_key</span><span class="p">:</span>
            <span class="n">cluster_str</span> <span class="o">=</span> <span class="s2">&quot;CLUSTERING ORDER BY &quot;</span>

            <span class="n">inner</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">clustering_key</span><span class="p">:</span>
                <span class="n">ordering</span> <span class="o">=</span> <span class="s2">&quot;DESC&quot;</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">is_reversed</span> <span class="k">else</span> <span class="s2">&quot;ASC&quot;</span>
                <span class="n">inner</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">protect_name</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">ordering</span><span class="p">))</span>

            <span class="n">cluster_str</span> <span class="o">+=</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span>
            <span class="n">properties</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster_str</span><span class="p">)</span>

        <span class="n">properties</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_make_option_strings</span><span class="p">(</span><span class="n">options_map</span><span class="p">))</span>

        <span class="n">join_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    AND &quot;</span> <span class="k">if</span> <span class="n">formatted</span> <span class="k">else</span> <span class="s2">&quot; AND &quot;</span>
        <span class="k">return</span> <span class="n">join_str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_make_option_strings</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">options_copy</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">options_map</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="n">actual_options</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">options_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;compaction_strategy_options&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">options_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;compaction_strategy_class&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">actual_options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">compaction_option_strings</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">actual_options</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;compaction = {</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">compaction_option_strings</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">system_table_name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">compaction_options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">options_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">system_table_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># delete if present</span>
        <span class="n">options_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;compaction_strategy_option&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">options_copy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compression&#39;</span><span class="p">):</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">options_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;compression_parameters&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="n">param_strings</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;compression = {</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param_strings</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">options_copy</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;comment&quot;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">protect_value</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span></div>


<span class="k">class</span> <span class="nc">TableExtensionInterface</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines CQL/DDL for Cassandra table extensions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># limited API for now. Could be expanded as new extension types materialize -- &quot;extend_option_strings&quot;, for example</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">after_table_cql</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ext_key</span><span class="p">,</span> <span class="n">ext_blob</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called to produce CQL/DDL to follow the table definition.</span>
<span class="sd">        Should contain requisite terminating semicolon(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">_RegisteredExtensionType</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>

    <span class="n">_extension_registry</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">_RegisteredExtensionType</span><span class="p">,</span> <span class="n">mcs</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;RegisteredTableExtension&#39;</span><span class="p">:</span>
            <span class="n">mcs</span><span class="o">.</span><span class="n">_extension_registry</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span>
        <span class="k">return</span> <span class="bp">cls</span>


<span class="nd">@six</span><span class="o">.</span><span class="n">add_metaclass</span><span class="p">(</span><span class="n">_RegisteredExtensionType</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RegisteredTableExtension</span><span class="p">(</span><span class="n">TableExtensionInterface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extending this class registers it by name (associated by key in the `system_schema.tables.extensions` map).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Name of the extension (key in the map)</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">protect_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">maybe_escape_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">protect_names</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">protect_name</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">protect_value</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;NULL&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">)</span>


<span class="n">valid_cql3_word_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[a-z][0-9a-z_]*$&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_valid_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">cql_keywords_reserved</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">valid_cql3_word_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">maybe_escape_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">is_valid_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span>
    <span class="k">return</span> <span class="n">escape_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">escape_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">),)</span>


<div class="viewcode-block" id="ColumnMetadata"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.ColumnMetadata">[docs]</a><span class="k">class</span> <span class="nc">ColumnMetadata</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A representation of a single column in a table.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">table</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot; The :class:`.TableMetadata` this column belongs to. &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot; The string name of this column. &quot;&quot;&quot;</span>

    <span class="n">cql_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The CQL type for the column.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">is_static</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If this column is static (available in Cassandra 2.1+), this will</span>
<span class="sd">    be :const:`True`, otherwise :const:`False`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">is_reversed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If this column is reversed (DESC) as in clustering order</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_cass_type</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_metadata</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">cql_type</span><span class="p">,</span> <span class="n">is_static</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_reversed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table_metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">column_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cql_type</span> <span class="o">=</span> <span class="n">cql_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_static</span> <span class="o">=</span> <span class="n">is_static</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_reversed</span> <span class="o">=</span> <span class="n">is_reversed</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cql_type</span><span class="p">)</span></div>


<div class="viewcode-block" id="IndexMetadata"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.IndexMetadata">[docs]</a><span class="k">class</span> <span class="nc">IndexMetadata</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A representation of a secondary index on a column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keyspace_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot; A string name of the keyspace. &quot;&quot;&quot;</span>

    <span class="n">table_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot; A string name of the table this index is on. &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot; A string name for the index. &quot;&quot;&quot;</span>

    <span class="n">kind</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot; A string representing the kind of index (COMPOSITE, CUSTOM,...). &quot;&quot;&quot;</span>

    <span class="n">index_options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="sd">&quot;&quot;&quot; A dict of index options. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspace_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">index_name</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">index_options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_name</span> <span class="o">=</span> <span class="n">keyspace_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">index_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_options</span> <span class="o">=</span> <span class="n">index_options</span>

<div class="viewcode-block" id="IndexMetadata.as_cql_query"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.IndexMetadata.as_cql_query">[docs]</a>    <span class="k">def</span> <span class="nf">as_cql_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a CQL query that can be used to recreate this index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_options</span><span class="p">)</span>
        <span class="n">index_target</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="s2">&quot;CUSTOM&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;CREATE INDEX </span><span class="si">%s</span><span class="s2"> ON </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyspace_name</span><span class="p">),</span>
                <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">),</span>
                <span class="n">index_target</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">class_name</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;class_name&quot;</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;CREATE CUSTOM INDEX </span><span class="si">%s</span><span class="s2"> ON </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) USING &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyspace_name</span><span class="p">),</span>
                <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">),</span>
                <span class="n">index_target</span><span class="p">,</span>
                <span class="n">class_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot; WITH OPTIONS = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Encoder</span><span class="p">()</span><span class="o">.</span><span class="n">cql_encode_all_types</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="IndexMetadata.export_as_string"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.IndexMetadata.export_as_string">[docs]</a>    <span class="k">def</span> <span class="nf">export_as_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a CQL query string that can be used to recreate this index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_cql_query</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span></div></div>


<div class="viewcode-block" id="TokenMap"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.TokenMap">[docs]</a><span class="k">class</span> <span class="nc">TokenMap</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Information about the layout of the ring.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">token_class</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A subclass of :class:`.Token`, depending on what partitioner the cluster uses.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">token_to_host_owner</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A map of :class:`.Token` objects to the :class:`.Host` that owns that token.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tokens_to_hosts_by_ks</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A map of keyspace names to a nested map of :class:`.Token` objects to</span>
<span class="sd">    sets of :class:`.Host` objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ring</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An ordered list of :class:`.Token` instances in the ring.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_metadata</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_class</span><span class="p">,</span> <span class="n">token_to_host_owner</span><span class="p">,</span> <span class="n">all_tokens</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_class</span> <span class="o">=</span> <span class="n">token_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ring</span> <span class="o">=</span> <span class="n">all_tokens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_to_host_owner</span> <span class="o">=</span> <span class="n">token_to_host_owner</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tokens_to_hosts_by_ks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rebuild_lock</span> <span class="o">=</span> <span class="n">RLock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">rebuild_keyspace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspace</span><span class="p">,</span> <span class="n">build_if_absent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rebuild_lock</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens_to_hosts_by_ks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keyspace</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">build_if_absent</span> <span class="ow">and</span> <span class="n">current</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">build_if_absent</span> <span class="ow">and</span> <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">ks_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">keyspaces</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keyspace</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ks_meta</span><span class="p">:</span>
                        <span class="n">replica_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replica_map_for_keyspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">keyspaces</span><span class="p">[</span><span class="n">keyspace</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tokens_to_hosts_by_ks</span><span class="p">[</span><span class="n">keyspace</span><span class="p">]</span> <span class="o">=</span> <span class="n">replica_map</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># should not happen normally, but we don&#39;t want to blow up queries because of unexpected meta state</span>
                <span class="c1"># bypass until new map is generated</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokens_to_hosts_by_ks</span><span class="p">[</span><span class="n">keyspace</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed creating a token map for keyspace &#39;</span><span class="si">%s</span><span class="s2">&#39; with </span><span class="si">%s</span><span class="s2">. PLEASE REPORT THIS: https://datastax-oss.atlassian.net/projects/PYTHON&quot;</span><span class="p">,</span> <span class="n">keyspace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_to_host_owner</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">replica_map_for_keyspace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ks_metadata</span><span class="p">):</span>
        <span class="n">strategy</span> <span class="o">=</span> <span class="n">ks_metadata</span><span class="o">.</span><span class="n">replication_strategy</span>
        <span class="k">if</span> <span class="n">strategy</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">strategy</span><span class="o">.</span><span class="n">make_token_replica_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token_to_host_owner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ring</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">remove_keyspace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspace</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokens_to_hosts_by_ks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">keyspace</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="TokenMap.get_replicas"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.TokenMap.get_replicas">[docs]</a>    <span class="k">def</span> <span class="nf">get_replicas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspace</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get  a set of :class:`.Host` instances representing all of the</span>
<span class="sd">        replica nodes for a given :class:`.Token`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tokens_to_hosts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens_to_hosts_by_ks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keyspace</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tokens_to_hosts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rebuild_keyspace</span><span class="p">(</span><span class="n">keyspace</span><span class="p">,</span> <span class="n">build_if_absent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">tokens_to_hosts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens_to_hosts_by_ks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keyspace</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tokens_to_hosts</span><span class="p">:</span>
            <span class="c1"># token range ownership is exclusive on the LHS (the start token), so</span>
            <span class="c1"># we use bisect_right, which, in the case of a tie/exact match,</span>
            <span class="c1"># picks an insertion point to the right of the existing match</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">bisect_right</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ring</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">point</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ring</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">tokens_to_hosts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ring</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">tokens_to_hosts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ring</span><span class="p">[</span><span class="n">point</span><span class="p">]]</span>
        <span class="k">return</span> <span class="p">[]</span></div></div>


<span class="nd">@total_ordering</span>
<div class="viewcode-block" id="Token"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.Token">[docs]</a><span class="k">class</span> <span class="nc">Token</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract class representing a token.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">token</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">hash_fn</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_key</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">hash_fn</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_string</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">token_string</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="fm">__str__</span> <span class="o">=</span> <span class="fm">__repr__</span></div>

<span class="n">MIN_LONG</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">63</span><span class="p">)</span>
<span class="n">MAX_LONG</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">63</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>


<span class="k">class</span> <span class="nc">NoMurmur3</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">HashToken</span><span class="p">(</span><span class="n">Token</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_string</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">token_string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; `token_string` should be the string representation from the server. &quot;&quot;&quot;</span>
        <span class="c1"># The hash partitioners just store the deciman value</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">token_string</span><span class="p">))</span>


<div class="viewcode-block" id="Murmur3Token"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.Murmur3Token">[docs]</a><span class="k">class</span> <span class="nc">Murmur3Token</span><span class="p">(</span><span class="n">HashToken</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A token for ``Murmur3Partitioner``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">hash_fn</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">murmur3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">murmur3</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">h</span> <span class="k">if</span> <span class="n">h</span> <span class="o">!=</span> <span class="n">MIN_LONG</span> <span class="k">else</span> <span class="n">MAX_LONG</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoMurmur3</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; `token` is an int or string representing the token. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">token</span><span class="p">)</span></div>


<div class="viewcode-block" id="MD5Token"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.MD5Token">[docs]</a><span class="k">class</span> <span class="nc">MD5Token</span><span class="p">(</span><span class="n">HashToken</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A token for ``RandomPartitioner``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">hash_fn</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">varint_unpack</span><span class="p">(</span><span class="n">md5</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()))</span></div>


<div class="viewcode-block" id="BytesToken"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.BytesToken">[docs]</a><span class="k">class</span> <span class="nc">BytesToken</span><span class="p">(</span><span class="n">Token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A token for ``ByteOrderedPartitioner``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="BytesToken.from_string"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.BytesToken.from_string">[docs]</a>    <span class="k">def</span> <span class="nf">from_string</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">token_string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; `token_string` should be the string representation from the server. &quot;&quot;&quot;</span>
        <span class="c1"># unhexlify works fine with unicode input in everythin but pypy3, where it Raises &quot;TypeError: &#39;str&#39; does not support the buffer interface&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token_string</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">):</span>
            <span class="n">token_string</span> <span class="o">=</span> <span class="n">token_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="c1"># The BOP stores a hex string</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">token_string</span><span class="p">))</span></div></div>


<span class="k">class</span> <span class="nc">TriggerMetadata</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A representation of a trigger for a table.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">table</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot; The :class:`.TableMetadata` this trigger belongs to. &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot; The string name of this trigger. &quot;&quot;&quot;</span>

    <span class="n">options</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dict mapping trigger option names to their specific settings for this</span>
<span class="sd">    table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_metadata</span><span class="p">,</span> <span class="n">trigger_name</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table_metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">trigger_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>

    <span class="k">def</span> <span class="nf">as_cql_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;CREATE TRIGGER </span><span class="si">%s</span><span class="s2"> ON </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2"> USING </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">keyspace_name</span><span class="p">),</span>
            <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="n">protect_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">export_as_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_cql_query</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span>


<span class="k">class</span> <span class="nc">_SchemaParser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>

    <span class="k">def</span> <span class="nf">_handle_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dict_factory</span><span class="p">(</span><span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_query_build_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_string</span><span class="p">,</span> <span class="n">build_func</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_build_rows</span><span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="n">build_func</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_query_build_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_string</span><span class="p">,</span> <span class="n">build_func</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query_string</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">ConsistencyLevel</span><span class="o">.</span><span class="n">ONE</span><span class="p">)</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">wait_for_responses</span><span class="p">((</span><span class="n">query</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">fail_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">dict_factory</span><span class="p">(</span><span class="o">*</span><span class="n">response</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">build_func</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">InvalidRequest</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;user types table not found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">response</span>


<span class="k">class</span> <span class="nc">SchemaParserV22</span><span class="p">(</span><span class="n">_SchemaParser</span><span class="p">):</span>
    <span class="n">_SELECT_KEYSPACES</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM system.schema_keyspaces&quot;</span>
    <span class="n">_SELECT_COLUMN_FAMILIES</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM system.schema_columnfamilies&quot;</span>
    <span class="n">_SELECT_COLUMNS</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM system.schema_columns&quot;</span>
    <span class="n">_SELECT_TRIGGERS</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM system.schema_triggers&quot;</span>
    <span class="n">_SELECT_TYPES</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM system.schema_usertypes&quot;</span>
    <span class="n">_SELECT_FUNCTIONS</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM system.schema_functions&quot;</span>
    <span class="n">_SELECT_AGGREGATES</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM system.schema_aggregates&quot;</span>

    <span class="n">_table_name_col</span> <span class="o">=</span> <span class="s1">&#39;columnfamily_name&#39;</span>

    <span class="n">_function_agg_arument_type_col</span> <span class="o">=</span> <span class="s1">&#39;signature&#39;</span>

    <span class="n">recognized_table_options</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;comment&quot;</span><span class="p">,</span>
        <span class="s2">&quot;read_repair_chance&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dclocal_read_repair_chance&quot;</span><span class="p">,</span>  <span class="c1"># kept to be safe, but see _build_table_options()</span>
        <span class="s2">&quot;local_read_repair_chance&quot;</span><span class="p">,</span>
        <span class="s2">&quot;replicate_on_write&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gc_grace_seconds&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bloom_filter_fp_chance&quot;</span><span class="p">,</span>
        <span class="s2">&quot;caching&quot;</span><span class="p">,</span>
        <span class="s2">&quot;compaction_strategy_class&quot;</span><span class="p">,</span>
        <span class="s2">&quot;compaction_strategy_options&quot;</span><span class="p">,</span>
        <span class="s2">&quot;min_compaction_threshold&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max_compaction_threshold&quot;</span><span class="p">,</span>
        <span class="s2">&quot;compression_parameters&quot;</span><span class="p">,</span>
        <span class="s2">&quot;min_index_interval&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max_index_interval&quot;</span><span class="p">,</span>
        <span class="s2">&quot;index_interval&quot;</span><span class="p">,</span>
        <span class="s2">&quot;speculative_retry&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rows_per_partition_to_cache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;memtable_flush_period_in_ms&quot;</span><span class="p">,</span>
        <span class="s2">&quot;populate_io_cache_on_flush&quot;</span><span class="p">,</span>
        <span class="s2">&quot;compression&quot;</span><span class="p">,</span>
        <span class="s2">&quot;default_time_to_live&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SchemaParserV22</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triggers_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functions_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregates_result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_table_rows</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_table_col_rows</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_type_rows</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_func_rows</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_agg_rows</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_table_trigger_rows</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_all_keyspaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query_all</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces_result</span><span class="p">:</span>
            <span class="n">keyspace_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_keyspace_metadata</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">table_row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_table_rows</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keyspace_meta</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="n">table_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_table_metadata</span><span class="p">(</span><span class="n">table_row</span><span class="p">)</span>
                    <span class="n">keyspace_meta</span><span class="o">.</span><span class="n">_add_table_metadata</span><span class="p">(</span><span class="n">table_meta</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">usertype_row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_type_rows</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keyspace_meta</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="n">usertype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_user_type</span><span class="p">(</span><span class="n">usertype_row</span><span class="p">)</span>
                    <span class="n">keyspace_meta</span><span class="o">.</span><span class="n">user_types</span><span class="p">[</span><span class="n">usertype</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">usertype</span>

                <span class="k">for</span> <span class="n">fn_row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_func_rows</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keyspace_meta</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_function</span><span class="p">(</span><span class="n">fn_row</span><span class="p">)</span>
                    <span class="n">keyspace_meta</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="n">fn</span><span class="o">.</span><span class="n">signature</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span>

                <span class="k">for</span> <span class="n">agg_row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_agg_rows</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keyspace_meta</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="n">agg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_aggregate</span><span class="p">(</span><span class="n">agg_row</span><span class="p">)</span>
                    <span class="n">keyspace_meta</span><span class="o">.</span><span class="n">aggregates</span><span class="p">[</span><span class="n">agg</span><span class="o">.</span><span class="n">signature</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error while parsing metadata for keyspace </span><span class="si">%s</span><span class="s2">. Metadata model will be incomplete.&quot;</span><span class="p">,</span> <span class="n">keyspace_meta</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">keyspace_meta</span><span class="o">.</span><span class="n">_exc_info</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>

            <span class="k">yield</span> <span class="n">keyspace_meta</span>

    <span class="k">def</span> <span class="nf">get_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspaces</span><span class="p">,</span> <span class="n">keyspace</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="n">ConsistencyLevel</span><span class="o">.</span><span class="n">ONE</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="n">bind_params</span><span class="p">(</span><span class="s2">&quot; WHERE keyspace_name = </span><span class="si">%%</span><span class="s2">s AND </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%%</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_name_col</span><span class="p">,),</span> <span class="p">(</span><span class="n">keyspace</span><span class="p">,</span> <span class="n">table</span><span class="p">),</span> <span class="n">_encoder</span><span class="p">)</span>
        <span class="n">cf_query</span> <span class="o">=</span> <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_COLUMN_FAMILIES</span> <span class="o">+</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">)</span>
        <span class="n">col_query</span> <span class="o">=</span> <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_COLUMNS</span> <span class="o">+</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">)</span>
        <span class="n">triggers_query</span> <span class="o">=</span> <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_TRIGGERS</span> <span class="o">+</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">)</span>
        <span class="p">(</span><span class="n">cf_success</span><span class="p">,</span> <span class="n">cf_result</span><span class="p">),</span> <span class="p">(</span><span class="n">col_success</span><span class="p">,</span> <span class="n">col_result</span><span class="p">),</span> <span class="p">(</span><span class="n">triggers_success</span><span class="p">,</span> <span class="n">triggers_result</span><span class="p">)</span> \
            <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">wait_for_responses</span><span class="p">(</span><span class="n">cf_query</span><span class="p">,</span> <span class="n">col_query</span><span class="p">,</span> <span class="n">triggers_query</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">fail_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">table_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">(</span><span class="n">cf_success</span><span class="p">,</span> <span class="n">cf_result</span><span class="p">)</span>
        <span class="n">col_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">(</span><span class="n">col_success</span><span class="p">,</span> <span class="n">col_result</span><span class="p">)</span>

        <span class="c1"># handle the triggers table not existing in Cassandra 1.2</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">triggers_success</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">triggers_result</span><span class="p">,</span> <span class="n">InvalidRequest</span><span class="p">):</span>
            <span class="n">triggers_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">triggers_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">(</span><span class="n">triggers_success</span><span class="p">,</span> <span class="n">triggers_result</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">table_result</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_table_metadata</span><span class="p">(</span><span class="n">table_result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">col_result</span><span class="p">,</span> <span class="n">triggers_result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspaces</span><span class="p">,</span> <span class="n">keyspace</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="n">bind_params</span><span class="p">(</span><span class="s2">&quot; WHERE keyspace_name = </span><span class="si">%s</span><span class="s2"> AND type_name = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">keyspace</span><span class="p">,</span> <span class="nb">type</span><span class="p">),</span> <span class="n">_encoder</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_build_row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_TYPES</span> <span class="o">+</span> <span class="n">where_clause</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_user_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_types_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspaces</span><span class="p">,</span> <span class="n">keyspace</span><span class="p">):</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="n">bind_params</span><span class="p">(</span><span class="s2">&quot; WHERE keyspace_name = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">keyspace</span><span class="p">,),</span> <span class="n">_encoder</span><span class="p">)</span>
        <span class="n">types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_build_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_TYPES</span> <span class="o">+</span> <span class="n">where_clause</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_user_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspaces</span><span class="p">,</span> <span class="n">keyspace</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="n">bind_params</span><span class="p">(</span><span class="s2">&quot; WHERE keyspace_name = </span><span class="si">%%</span><span class="s2">s AND function_name = </span><span class="si">%%</span><span class="s2">s AND </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%%</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_function_agg_arument_type_col</span><span class="p">,),</span>
                                   <span class="p">(</span><span class="n">keyspace</span><span class="p">,</span> <span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">function</span><span class="o">.</span><span class="n">argument_types</span><span class="p">),</span> <span class="n">_encoder</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_build_row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_FUNCTIONS</span> <span class="o">+</span> <span class="n">where_clause</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_function</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspaces</span><span class="p">,</span> <span class="n">keyspace</span><span class="p">,</span> <span class="n">aggregate</span><span class="p">):</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="n">bind_params</span><span class="p">(</span><span class="s2">&quot; WHERE keyspace_name = </span><span class="si">%%</span><span class="s2">s AND aggregate_name = </span><span class="si">%%</span><span class="s2">s AND </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%%</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_function_agg_arument_type_col</span><span class="p">,),</span>
                                   <span class="p">(</span><span class="n">keyspace</span><span class="p">,</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">argument_types</span><span class="p">),</span> <span class="n">_encoder</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_build_row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_AGGREGATES</span> <span class="o">+</span> <span class="n">where_clause</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_aggregate</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_keyspace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspaces</span><span class="p">,</span> <span class="n">keyspace</span><span class="p">):</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="n">bind_params</span><span class="p">(</span><span class="s2">&quot; WHERE keyspace_name = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">keyspace</span><span class="p">,),</span> <span class="n">_encoder</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_build_row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_KEYSPACES</span> <span class="o">+</span> <span class="n">where_clause</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_keyspace_metadata</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_build_keyspace_metadata</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ksm</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_build_keyspace_metadata_internal</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;keyspace_name&quot;</span><span class="p">]</span>
            <span class="n">ksm</span> <span class="o">=</span> <span class="n">KeyspaceMetadata</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;UNKNOWN&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">ksm</span><span class="o">.</span><span class="n">_exc_info</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>  <span class="c1"># capture exc_info before log because nose (test) logging clears it in certain circumstances</span>
            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error while parsing metadata for keyspace </span><span class="si">%s</span><span class="s2"> row(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ksm</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_build_keyspace_metadata_internal</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;keyspace_name&quot;</span><span class="p">]</span>
        <span class="n">durable_writes</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;durable_writes&quot;</span><span class="p">]</span>
        <span class="n">strategy_class</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;strategy_class&quot;</span><span class="p">]</span>
        <span class="n">strategy_options</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;strategy_options&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">KeyspaceMetadata</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">durable_writes</span><span class="p">,</span> <span class="n">strategy_class</span><span class="p">,</span> <span class="n">strategy_options</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_build_user_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">usertype_row</span><span class="p">):</span>
        <span class="n">field_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_schema_type_to_cql</span><span class="p">,</span> <span class="n">usertype_row</span><span class="p">[</span><span class="s1">&#39;field_types&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">UserType</span><span class="p">(</span><span class="n">usertype_row</span><span class="p">[</span><span class="s1">&#39;keyspace_name&#39;</span><span class="p">],</span> <span class="n">usertype_row</span><span class="p">[</span><span class="s1">&#39;type_name&#39;</span><span class="p">],</span>
                        <span class="n">usertype_row</span><span class="p">[</span><span class="s1">&#39;field_names&#39;</span><span class="p">],</span> <span class="n">field_types</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_build_function</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">function_row</span><span class="p">):</span>
        <span class="n">return_type</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_schema_type_to_cql</span><span class="p">(</span><span class="n">function_row</span><span class="p">[</span><span class="s1">&#39;return_type&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">Function</span><span class="p">(</span><span class="n">function_row</span><span class="p">[</span><span class="s1">&#39;keyspace_name&#39;</span><span class="p">],</span> <span class="n">function_row</span><span class="p">[</span><span class="s1">&#39;function_name&#39;</span><span class="p">],</span>
                        <span class="n">function_row</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_function_agg_arument_type_col</span><span class="p">],</span> <span class="n">function_row</span><span class="p">[</span><span class="s1">&#39;argument_names&#39;</span><span class="p">],</span>
                        <span class="n">return_type</span><span class="p">,</span> <span class="n">function_row</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">],</span> <span class="n">function_row</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">],</span>
                        <span class="n">function_row</span><span class="p">[</span><span class="s1">&#39;called_on_null_input&#39;</span><span class="p">])</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_build_aggregate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">aggregate_row</span><span class="p">):</span>
        <span class="n">cass_state_type</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">lookup_casstype</span><span class="p">(</span><span class="n">aggregate_row</span><span class="p">[</span><span class="s1">&#39;state_type&#39;</span><span class="p">])</span>
        <span class="n">initial_condition</span> <span class="o">=</span> <span class="n">aggregate_row</span><span class="p">[</span><span class="s1">&#39;initcond&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">initial_condition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initial_condition</span> <span class="o">=</span> <span class="n">_encoder</span><span class="o">.</span><span class="n">cql_encode_all_types</span><span class="p">(</span><span class="n">cass_state_type</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">initial_condition</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">state_type</span> <span class="o">=</span> <span class="n">_cql_from_cass_type</span><span class="p">(</span><span class="n">cass_state_type</span><span class="p">)</span>
        <span class="n">return_type</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_schema_type_to_cql</span><span class="p">(</span><span class="n">aggregate_row</span><span class="p">[</span><span class="s1">&#39;return_type&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">Aggregate</span><span class="p">(</span><span class="n">aggregate_row</span><span class="p">[</span><span class="s1">&#39;keyspace_name&#39;</span><span class="p">],</span> <span class="n">aggregate_row</span><span class="p">[</span><span class="s1">&#39;aggregate_name&#39;</span><span class="p">],</span>
                         <span class="n">aggregate_row</span><span class="p">[</span><span class="s1">&#39;signature&#39;</span><span class="p">],</span> <span class="n">aggregate_row</span><span class="p">[</span><span class="s1">&#39;state_func&#39;</span><span class="p">],</span> <span class="n">state_type</span><span class="p">,</span>
                         <span class="n">aggregate_row</span><span class="p">[</span><span class="s1">&#39;final_func&#39;</span><span class="p">],</span> <span class="n">initial_condition</span><span class="p">,</span> <span class="n">return_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_table_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col_rows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trigger_rows</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">keyspace_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;keyspace_name&quot;</span><span class="p">]</span>
        <span class="n">cfname</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_name_col</span><span class="p">]</span>

        <span class="n">col_rows</span> <span class="o">=</span> <span class="n">col_rows</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_table_col_rows</span><span class="p">[</span><span class="n">keyspace_name</span><span class="p">][</span><span class="n">cfname</span><span class="p">]</span>
        <span class="n">trigger_rows</span> <span class="o">=</span> <span class="n">trigger_rows</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_table_trigger_rows</span><span class="p">[</span><span class="n">keyspace_name</span><span class="p">][</span><span class="n">cfname</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">col_rows</span><span class="p">:</span>  <span class="c1"># CASSANDRA-8487</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Building table metadata with no column meta for </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">keyspace_name</span><span class="p">,</span> <span class="n">cfname</span><span class="p">)</span>

        <span class="n">table_meta</span> <span class="o">=</span> <span class="n">TableMetadata</span><span class="p">(</span><span class="n">keyspace_name</span><span class="p">,</span> <span class="n">cfname</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">comparator</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">lookup_casstype</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;comparator&quot;</span><span class="p">])</span>
            <span class="n">table_meta</span><span class="o">.</span><span class="n">comparator</span> <span class="o">=</span> <span class="n">comparator</span>

            <span class="n">is_dct_comparator</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">comparator</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">DynamicCompositeType</span><span class="p">)</span>
            <span class="n">is_composite_comparator</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">comparator</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">CompositeType</span><span class="p">)</span>
            <span class="n">column_name_types</span> <span class="o">=</span> <span class="n">comparator</span><span class="o">.</span><span class="n">subtypes</span> <span class="k">if</span> <span class="n">is_composite_comparator</span> <span class="k">else</span> <span class="p">(</span><span class="n">comparator</span><span class="p">,)</span>

            <span class="n">num_column_name_components</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_name_types</span><span class="p">)</span>
            <span class="n">last_col</span> <span class="o">=</span> <span class="n">column_name_types</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">column_aliases</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;column_aliases&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="n">clustering_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">col_rows</span>
                               <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;clustering_key&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clustering_rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">clustering_rows</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">clustering_rows</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;component_index&#39;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">column_aliases</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">column_aliases</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">column_aliases</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">column_aliases</span><span class="p">:</span>  <span class="c1"># json load failed or column_aliases empty PYTHON-562</span>
                <span class="n">column_aliases</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column_name&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">clustering_rows</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">is_composite_comparator</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">last_col</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ColumnToCollectionType</span><span class="p">):</span>
                    <span class="c1"># collections</span>
                    <span class="n">is_compact</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">has_value</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">clustering_size</span> <span class="o">=</span> <span class="n">num_column_name_components</span> <span class="o">-</span> <span class="mi">2</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">column_aliases</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_column_name_components</span> <span class="o">-</span> <span class="mi">1</span>
                      <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">last_col</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UTF8Type</span><span class="p">)):</span>
                    <span class="c1"># aliases?</span>
                    <span class="n">is_compact</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">has_value</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">clustering_size</span> <span class="o">=</span> <span class="n">num_column_name_components</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># compact table</span>
                    <span class="n">is_compact</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">has_value</span> <span class="o">=</span> <span class="n">column_aliases</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">col_rows</span>
                    <span class="n">clustering_size</span> <span class="o">=</span> <span class="n">num_column_name_components</span>

                    <span class="c1"># Some thrift tables define names in composite types (see PYTHON-192)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">column_aliases</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">comparator</span><span class="p">,</span> <span class="s1">&#39;fieldnames&#39;</span><span class="p">):</span>
                        <span class="n">column_aliases</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">comparator</span><span class="o">.</span><span class="n">fieldnames</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_compact</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">column_aliases</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">col_rows</span> <span class="ow">or</span> <span class="n">is_dct_comparator</span><span class="p">:</span>
                    <span class="n">has_value</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">clustering_size</span> <span class="o">=</span> <span class="n">num_column_name_components</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">has_value</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">clustering_size</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># partition key</span>
            <span class="n">partition_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">col_rows</span>
                              <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;partition_key&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">partition_rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">partition_rows</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">partition_rows</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;component_index&#39;</span><span class="p">))</span>

            <span class="n">key_aliases</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key_aliases&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key_aliases</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">key_aliases</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">key_aliases</span><span class="p">)</span> <span class="k">if</span> <span class="n">key_aliases</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># In 2.0+, we can use the &#39;type&#39; column. In 3.0+, we have to use it.</span>
                <span class="n">key_aliases</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column_name&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">partition_rows</span><span class="p">]</span>

            <span class="n">key_validator</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key_validator&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key_validator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">key_type</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">lookup_casstype</span><span class="p">(</span><span class="n">key_validator</span><span class="p">)</span>
                <span class="n">key_types</span> <span class="o">=</span> <span class="n">key_type</span><span class="o">.</span><span class="n">subtypes</span> <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">key_type</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">CompositeType</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">key_type</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">lookup_casstype</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;validator&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">partition_rows</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col_type</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">key_types</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_aliases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                    <span class="n">column_name</span> <span class="o">=</span> <span class="n">key_aliases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">column_name</span> <span class="o">=</span> <span class="s2">&quot;key&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">column_name</span> <span class="o">=</span> <span class="s2">&quot;key</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span>

                <span class="n">col</span> <span class="o">=</span> <span class="n">ColumnMetadata</span><span class="p">(</span><span class="n">table_meta</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">col_type</span><span class="o">.</span><span class="n">cql_parameterized_type</span><span class="p">())</span>
                <span class="n">table_meta</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>
                <span class="n">table_meta</span><span class="o">.</span><span class="n">partition_key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

            <span class="c1"># clustering key</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">clustering_size</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_aliases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                    <span class="n">column_name</span> <span class="o">=</span> <span class="n">column_aliases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">column_name</span> <span class="o">=</span> <span class="s2">&quot;column</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

                <span class="n">data_type</span> <span class="o">=</span> <span class="n">column_name_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">cql_type</span> <span class="o">=</span> <span class="n">_cql_from_cass_type</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>
                <span class="n">is_reversed</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">is_reversed_casstype</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">ColumnMetadata</span><span class="p">(</span><span class="n">table_meta</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">cql_type</span><span class="p">,</span> <span class="n">is_reversed</span><span class="o">=</span><span class="n">is_reversed</span><span class="p">)</span>
                <span class="n">table_meta</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>
                <span class="n">table_meta</span><span class="o">.</span><span class="n">clustering_key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

            <span class="c1"># value alias (if present)</span>
            <span class="k">if</span> <span class="n">has_value</span><span class="p">:</span>
                <span class="n">value_alias_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">col_rows</span>
                                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;compact_value&quot;</span><span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">key_aliases</span><span class="p">:</span>  <span class="c1"># TODO are we checking the right thing here?</span>
                    <span class="n">value_alias</span> <span class="o">=</span> <span class="s2">&quot;value&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value_alias</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value_alias&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">value_alias</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value_alias_rows</span><span class="p">:</span>  <span class="c1"># CASSANDRA-8487</span>
                        <span class="c1"># In 2.0+, we can use the &#39;type&#39; column. In 3.0+, we have to use it.</span>
                        <span class="n">value_alias</span> <span class="o">=</span> <span class="n">value_alias_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column_name&#39;</span><span class="p">)</span>

                <span class="n">default_validator</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_validator&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">default_validator</span><span class="p">:</span>
                    <span class="n">validator</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">lookup_casstype</span><span class="p">(</span><span class="n">default_validator</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value_alias_rows</span><span class="p">:</span>  <span class="c1"># CASSANDRA-8487</span>
                        <span class="n">validator</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">lookup_casstype</span><span class="p">(</span><span class="n">value_alias_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;validator&#39;</span><span class="p">))</span>

                <span class="n">cql_type</span> <span class="o">=</span> <span class="n">_cql_from_cass_type</span><span class="p">(</span><span class="n">validator</span><span class="p">)</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">ColumnMetadata</span><span class="p">(</span><span class="n">table_meta</span><span class="p">,</span> <span class="n">value_alias</span><span class="p">,</span> <span class="n">cql_type</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value_alias</span><span class="p">:</span>  <span class="c1"># CASSANDRA-8487</span>
                    <span class="n">table_meta</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">value_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>

            <span class="c1"># other normal columns</span>
            <span class="k">for</span> <span class="n">col_row</span> <span class="ow">in</span> <span class="n">col_rows</span><span class="p">:</span>
                <span class="n">column_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_column_metadata</span><span class="p">(</span><span class="n">table_meta</span><span class="p">,</span> <span class="n">col_row</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">column_meta</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">table_meta</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">column_meta</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_meta</span>
                    <span class="n">index_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_index_metadata</span><span class="p">(</span><span class="n">column_meta</span><span class="p">,</span> <span class="n">col_row</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">index_meta</span><span class="p">:</span>
                        <span class="n">table_meta</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">index_meta</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_meta</span>

            <span class="k">for</span> <span class="n">trigger_row</span> <span class="ow">in</span> <span class="n">trigger_rows</span><span class="p">:</span>
                <span class="n">trigger_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_trigger_metadata</span><span class="p">(</span><span class="n">table_meta</span><span class="p">,</span> <span class="n">trigger_row</span><span class="p">)</span>
                <span class="n">table_meta</span><span class="o">.</span><span class="n">triggers</span><span class="p">[</span><span class="n">trigger_meta</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">trigger_meta</span>

            <span class="n">table_meta</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_table_options</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">table_meta</span><span class="o">.</span><span class="n">is_compact_storage</span> <span class="o">=</span> <span class="n">is_compact</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">table_meta</span><span class="o">.</span><span class="n">_exc_info</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error while parsing metadata for table </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2"> row(</span><span class="si">%s</span><span class="s2">) columns(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">keyspace_name</span><span class="p">,</span> <span class="n">cfname</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col_rows</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">table_meta</span>

    <span class="k">def</span> <span class="nf">_build_table_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Setup the mostly-non-schema table options, like caching settings &quot;&quot;&quot;</span>
        <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">o</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">o</span><span class="p">))</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recognized_table_options</span> <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">row</span><span class="p">)</span>

        <span class="c1"># the option name when creating tables is &quot;dclocal_read_repair_chance&quot;,</span>
        <span class="c1"># but the column name in system.schema_columnfamilies is</span>
        <span class="c1"># &quot;local_read_repair_chance&quot;.  We&#39;ll store this as dclocal_read_repair_chance,</span>
        <span class="c1"># since that&#39;s probably what users are expecting (and we need it for the</span>
        <span class="c1"># CREATE TABLE statement anyway).</span>
        <span class="k">if</span> <span class="s2">&quot;local_read_repair_chance&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;local_read_repair_chance&quot;</span><span class="p">)</span>
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;dclocal_read_repair_chance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">return</span> <span class="n">options</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_build_column_metadata</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">table_metadata</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;column_name&quot;</span><span class="p">]</span>
        <span class="n">type_string</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;validator&quot;</span><span class="p">]</span>
        <span class="n">data_type</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">lookup_casstype</span><span class="p">(</span><span class="n">type_string</span><span class="p">)</span>
        <span class="n">cql_type</span> <span class="o">=</span> <span class="n">_cql_from_cass_type</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>
        <span class="n">is_static</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;static&quot;</span>
        <span class="n">is_reversed</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">is_reversed_casstype</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>
        <span class="n">column_meta</span> <span class="o">=</span> <span class="n">ColumnMetadata</span><span class="p">(</span><span class="n">table_metadata</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cql_type</span><span class="p">,</span> <span class="n">is_static</span><span class="p">,</span> <span class="n">is_reversed</span><span class="p">)</span>
        <span class="n">column_meta</span><span class="o">.</span><span class="n">_cass_type</span> <span class="o">=</span> <span class="n">data_type</span>
        <span class="k">return</span> <span class="n">column_meta</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_build_index_metadata</span><span class="p">(</span><span class="n">column_metadata</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index_name&quot;</span><span class="p">)</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index_type&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index_name</span> <span class="ow">or</span> <span class="n">kind</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index_options&quot;</span><span class="p">)</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="k">if</span> <span class="n">options</span> <span class="k">else</span> <span class="p">{}</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">options</span> <span class="ow">or</span> <span class="p">{}</span>  <span class="c1"># if the json parsed to None, init empty dict</span>

            <span class="c1"># generate a CQL index identity string</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">protect_name</span><span class="p">(</span><span class="n">column_metadata</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">!=</span> <span class="s2">&quot;CUSTOM&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;index_keys&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;keys(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target</span><span class="p">,)</span>
                <span class="k">elif</span> <span class="s2">&quot;index_values&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
                    <span class="c1"># don&#39;t use any &quot;function&quot; for collection values</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># it might be a &quot;full&quot; index on a frozen collection, but</span>
                    <span class="c1"># we need to check the data type to verify that, because</span>
                    <span class="c1"># there is no special index option for full-collection</span>
                    <span class="c1"># indexes.</span>
                    <span class="n">data_type</span> <span class="o">=</span> <span class="n">column_metadata</span><span class="o">.</span><span class="n">_cass_type</span>
                    <span class="n">collection_types</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">data_type</span><span class="o">.</span><span class="n">typename</span> <span class="o">==</span> <span class="s2">&quot;frozen&quot;</span> <span class="ow">and</span> <span class="n">data_type</span><span class="o">.</span><span class="n">subtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">typename</span> <span class="ow">in</span> <span class="n">collection_types</span><span class="p">:</span>
                        <span class="c1"># no index option for full-collection index</span>
                        <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;full(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target</span><span class="p">,)</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>
            <span class="k">return</span> <span class="n">IndexMetadata</span><span class="p">(</span><span class="n">column_metadata</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">keyspace_name</span><span class="p">,</span> <span class="n">column_metadata</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">index_name</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_build_trigger_metadata</span><span class="p">(</span><span class="n">table_metadata</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;trigger_name&quot;</span><span class="p">]</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;trigger_options&quot;</span><span class="p">]</span>
        <span class="n">trigger_meta</span> <span class="o">=</span> <span class="n">TriggerMetadata</span><span class="p">(</span><span class="n">table_metadata</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">trigger_meta</span>

    <span class="k">def</span> <span class="nf">_query_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="n">ConsistencyLevel</span><span class="o">.</span><span class="n">ONE</span>
        <span class="n">queries</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_KEYSPACES</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">),</span>
            <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_COLUMN_FAMILIES</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">),</span>
            <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_COLUMNS</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">),</span>
            <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_TYPES</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">),</span>
            <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_FUNCTIONS</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">),</span>
            <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_AGGREGATES</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">),</span>
            <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_TRIGGERS</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">wait_for_responses</span><span class="p">(</span><span class="o">*</span><span class="n">queries</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">fail_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">(</span><span class="n">ks_success</span><span class="p">,</span> <span class="n">ks_result</span><span class="p">),</span> <span class="p">(</span><span class="n">table_success</span><span class="p">,</span> <span class="n">table_result</span><span class="p">),</span> \
        <span class="p">(</span><span class="n">col_success</span><span class="p">,</span> <span class="n">col_result</span><span class="p">),</span> <span class="p">(</span><span class="n">types_success</span><span class="p">,</span> <span class="n">types_result</span><span class="p">),</span> \
        <span class="p">(</span><span class="n">functions_success</span><span class="p">,</span> <span class="n">functions_result</span><span class="p">),</span> \
        <span class="p">(</span><span class="n">aggregates_success</span><span class="p">,</span> <span class="n">aggregates_result</span><span class="p">),</span> \
        <span class="p">(</span><span class="n">triggers_success</span><span class="p">,</span> <span class="n">triggers_result</span><span class="p">)</span> <span class="o">=</span> <span class="n">responses</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">(</span><span class="n">ks_success</span><span class="p">,</span> <span class="n">ks_result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">(</span><span class="n">table_success</span><span class="p">,</span> <span class="n">table_result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">(</span><span class="n">col_success</span><span class="p">,</span> <span class="n">col_result</span><span class="p">)</span>

        <span class="c1"># if we&#39;re connected to Cassandra &lt; 2.0, the triggers table will not exist</span>
        <span class="k">if</span> <span class="n">triggers_success</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triggers_result</span> <span class="o">=</span> <span class="n">dict_factory</span><span class="p">(</span><span class="o">*</span><span class="n">triggers_result</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">triggers_result</span><span class="p">,</span> <span class="n">InvalidRequest</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;triggers table not found&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">triggers_result</span><span class="p">,</span> <span class="n">Unauthorized</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;this version of Cassandra does not allow access to schema_triggers metadata with authorization enabled (CASSANDRA-7967); &quot;</span>
                            <span class="s2">&quot;The driver will operate normally, but will not reflect triggers in the local metadata model, or schema strings.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">triggers_result</span>

        <span class="c1"># if we&#39;re connected to Cassandra &lt; 2.1, the usertypes table will not exist</span>
        <span class="k">if</span> <span class="n">types_success</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">types_result</span> <span class="o">=</span> <span class="n">dict_factory</span><span class="p">(</span><span class="o">*</span><span class="n">types_result</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">types_result</span><span class="p">,</span> <span class="n">InvalidRequest</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;user types table not found&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">types_result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">types_result</span>

        <span class="c1"># functions were introduced in Cassandra 2.2</span>
        <span class="k">if</span> <span class="n">functions_success</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">functions_result</span> <span class="o">=</span> <span class="n">dict_factory</span><span class="p">(</span><span class="o">*</span><span class="n">functions_result</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">functions_result</span><span class="p">,</span> <span class="n">InvalidRequest</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;user functions table not found&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">functions_result</span>

        <span class="c1"># aggregates were introduced in Cassandra 2.2</span>
        <span class="k">if</span> <span class="n">aggregates_success</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aggregates_result</span> <span class="o">=</span> <span class="n">dict_factory</span><span class="p">(</span><span class="o">*</span><span class="n">aggregates_result</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aggregates_result</span><span class="p">,</span> <span class="n">InvalidRequest</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;user aggregates table not found&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">aggregates_result</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_results</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_aggregate_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_table_rows</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables_result</span><span class="p">:</span>
            <span class="n">m</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;keyspace_name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_table_col_rows</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns_result</span><span class="p">:</span>
            <span class="n">ksname</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;keyspace_name&quot;</span><span class="p">]</span>
            <span class="n">cfname</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_name_col</span><span class="p">]</span>
            <span class="n">m</span><span class="p">[</span><span class="n">ksname</span><span class="p">][</span><span class="n">cfname</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_type_rows</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">types_result</span><span class="p">:</span>
            <span class="n">m</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;keyspace_name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_func_rows</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">functions_result</span><span class="p">:</span>
            <span class="n">m</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;keyspace_name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_agg_rows</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregates_result</span><span class="p">:</span>
            <span class="n">m</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;keyspace_name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_table_trigger_rows</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">triggers_result</span><span class="p">:</span>
            <span class="n">ksname</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;keyspace_name&quot;</span><span class="p">]</span>
            <span class="n">cfname</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_name_col</span><span class="p">]</span>
            <span class="n">m</span><span class="p">[</span><span class="n">ksname</span><span class="p">][</span><span class="n">cfname</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_schema_type_to_cql</span><span class="p">(</span><span class="n">type_string</span><span class="p">):</span>
        <span class="n">cass_type</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">lookup_casstype</span><span class="p">(</span><span class="n">type_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_cql_from_cass_type</span><span class="p">(</span><span class="n">cass_type</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SchemaParserV3</span><span class="p">(</span><span class="n">SchemaParserV22</span><span class="p">):</span>
    <span class="n">_SELECT_KEYSPACES</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM system_schema.keyspaces&quot;</span>
    <span class="n">_SELECT_TABLES</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM system_schema.tables&quot;</span>
    <span class="n">_SELECT_COLUMNS</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM system_schema.columns&quot;</span>
    <span class="n">_SELECT_INDEXES</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM system_schema.indexes&quot;</span>
    <span class="n">_SELECT_TRIGGERS</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM system_schema.triggers&quot;</span>
    <span class="n">_SELECT_TYPES</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM system_schema.types&quot;</span>
    <span class="n">_SELECT_FUNCTIONS</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM system_schema.functions&quot;</span>
    <span class="n">_SELECT_AGGREGATES</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM system_schema.aggregates&quot;</span>
    <span class="n">_SELECT_VIEWS</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM system_schema.views&quot;</span>

    <span class="n">_table_name_col</span> <span class="o">=</span> <span class="s1">&#39;table_name&#39;</span>

    <span class="n">_function_agg_arument_type_col</span> <span class="o">=</span> <span class="s1">&#39;argument_types&#39;</span>

    <span class="n">recognized_table_options</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;bloom_filter_fp_chance&#39;</span><span class="p">,</span>
        <span class="s1">&#39;caching&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cdc&#39;</span><span class="p">,</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">,</span>
        <span class="s1">&#39;compaction&#39;</span><span class="p">,</span>
        <span class="s1">&#39;compression&#39;</span><span class="p">,</span>
        <span class="s1">&#39;crc_check_chance&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dclocal_read_repair_chance&#39;</span><span class="p">,</span>
        <span class="s1">&#39;default_time_to_live&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gc_grace_seconds&#39;</span><span class="p">,</span>
        <span class="s1">&#39;max_index_interval&#39;</span><span class="p">,</span>
        <span class="s1">&#39;memtable_flush_period_in_ms&#39;</span><span class="p">,</span>
        <span class="s1">&#39;min_index_interval&#39;</span><span class="p">,</span>
        <span class="s1">&#39;read_repair_chance&#39;</span><span class="p">,</span>
        <span class="s1">&#39;speculative_retry&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SchemaParserV3</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexes_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_table_index_rows</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_view_rows</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_all_keyspaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">keyspace_meta</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">SchemaParserV3</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_all_keyspaces</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_view_rows</span><span class="p">[</span><span class="n">keyspace_meta</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span>
                <span class="n">view_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_view_metadata</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">keyspace_meta</span><span class="o">.</span><span class="n">_add_view_metadata</span><span class="p">(</span><span class="n">view_meta</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">keyspace_meta</span>

    <span class="k">def</span> <span class="nf">get_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspaces</span><span class="p">,</span> <span class="n">keyspace</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="n">ConsistencyLevel</span><span class="o">.</span><span class="n">ONE</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="n">bind_params</span><span class="p">(</span><span class="s2">&quot; WHERE keyspace_name = </span><span class="si">%%</span><span class="s2">s AND </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%%</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_name_col</span><span class="p">),</span> <span class="p">(</span><span class="n">keyspace</span><span class="p">,</span> <span class="n">table</span><span class="p">),</span> <span class="n">_encoder</span><span class="p">)</span>
        <span class="n">cf_query</span> <span class="o">=</span> <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_TABLES</span> <span class="o">+</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">)</span>
        <span class="n">col_query</span> <span class="o">=</span> <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_COLUMNS</span> <span class="o">+</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">)</span>
        <span class="n">indexes_query</span> <span class="o">=</span> <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_INDEXES</span> <span class="o">+</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">)</span>
        <span class="n">triggers_query</span> <span class="o">=</span> <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_TRIGGERS</span> <span class="o">+</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">)</span>

        <span class="c1"># in protocol v4 we don&#39;t know if this event is a view or a table, so we look for both</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="n">bind_params</span><span class="p">(</span><span class="s2">&quot; WHERE keyspace_name = </span><span class="si">%s</span><span class="s2"> AND view_name = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">keyspace</span><span class="p">,</span> <span class="n">table</span><span class="p">),</span> <span class="n">_encoder</span><span class="p">)</span>
        <span class="n">view_query</span> <span class="o">=</span> <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_VIEWS</span> <span class="o">+</span> <span class="n">where_clause</span><span class="p">,</span>
                                  <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">)</span>
        <span class="p">(</span><span class="n">cf_success</span><span class="p">,</span> <span class="n">cf_result</span><span class="p">),</span> <span class="p">(</span><span class="n">col_success</span><span class="p">,</span> <span class="n">col_result</span><span class="p">),</span> <span class="p">(</span><span class="n">indexes_sucess</span><span class="p">,</span> <span class="n">indexes_result</span><span class="p">),</span> \
        <span class="p">(</span><span class="n">triggers_success</span><span class="p">,</span> <span class="n">triggers_result</span><span class="p">),</span> <span class="p">(</span><span class="n">view_success</span><span class="p">,</span> <span class="n">view_result</span><span class="p">)</span> \
            <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">wait_for_responses</span><span class="p">(</span><span class="n">cf_query</span><span class="p">,</span> <span class="n">col_query</span><span class="p">,</span> <span class="n">indexes_query</span><span class="p">,</span> <span class="n">triggers_query</span><span class="p">,</span> <span class="n">view_query</span><span class="p">,</span>
                                                 <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">fail_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">table_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">(</span><span class="n">cf_success</span><span class="p">,</span> <span class="n">cf_result</span><span class="p">)</span>
        <span class="n">col_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">(</span><span class="n">col_success</span><span class="p">,</span> <span class="n">col_result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">table_result</span><span class="p">:</span>
            <span class="n">indexes_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">(</span><span class="n">indexes_sucess</span><span class="p">,</span> <span class="n">indexes_result</span><span class="p">)</span>
            <span class="n">triggers_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">(</span><span class="n">triggers_success</span><span class="p">,</span> <span class="n">triggers_result</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_table_metadata</span><span class="p">(</span><span class="n">table_result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">col_result</span><span class="p">,</span> <span class="n">triggers_result</span><span class="p">,</span> <span class="n">indexes_result</span><span class="p">)</span>

        <span class="n">view_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">(</span><span class="n">view_success</span><span class="p">,</span> <span class="n">view_result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">view_result</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_view_metadata</span><span class="p">(</span><span class="n">view_result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">col_result</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_build_keyspace_metadata_internal</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;keyspace_name&quot;</span><span class="p">]</span>
        <span class="n">durable_writes</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;durable_writes&quot;</span><span class="p">]</span>
        <span class="n">strategy_options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;replication&quot;</span><span class="p">])</span>
        <span class="n">strategy_class</span> <span class="o">=</span> <span class="n">strategy_options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">KeyspaceMetadata</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">durable_writes</span><span class="p">,</span> <span class="n">strategy_class</span><span class="p">,</span> <span class="n">strategy_options</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_build_aggregate</span><span class="p">(</span><span class="n">aggregate_row</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Aggregate</span><span class="p">(</span><span class="n">aggregate_row</span><span class="p">[</span><span class="s1">&#39;keyspace_name&#39;</span><span class="p">],</span> <span class="n">aggregate_row</span><span class="p">[</span><span class="s1">&#39;aggregate_name&#39;</span><span class="p">],</span>
                         <span class="n">aggregate_row</span><span class="p">[</span><span class="s1">&#39;argument_types&#39;</span><span class="p">],</span> <span class="n">aggregate_row</span><span class="p">[</span><span class="s1">&#39;state_func&#39;</span><span class="p">],</span> <span class="n">aggregate_row</span><span class="p">[</span><span class="s1">&#39;state_type&#39;</span><span class="p">],</span>
                         <span class="n">aggregate_row</span><span class="p">[</span><span class="s1">&#39;final_func&#39;</span><span class="p">],</span> <span class="n">aggregate_row</span><span class="p">[</span><span class="s1">&#39;initcond&#39;</span><span class="p">],</span> <span class="n">aggregate_row</span><span class="p">[</span><span class="s1">&#39;return_type&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_build_table_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col_rows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trigger_rows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index_rows</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">keyspace_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;keyspace_name&quot;</span><span class="p">]</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_name_col</span><span class="p">]</span>

        <span class="n">col_rows</span> <span class="o">=</span> <span class="n">col_rows</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_table_col_rows</span><span class="p">[</span><span class="n">keyspace_name</span><span class="p">][</span><span class="n">table_name</span><span class="p">]</span>
        <span class="n">trigger_rows</span> <span class="o">=</span> <span class="n">trigger_rows</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_table_trigger_rows</span><span class="p">[</span><span class="n">keyspace_name</span><span class="p">][</span><span class="n">table_name</span><span class="p">]</span>
        <span class="n">index_rows</span> <span class="o">=</span> <span class="n">index_rows</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_table_index_rows</span><span class="p">[</span><span class="n">keyspace_name</span><span class="p">][</span><span class="n">table_name</span><span class="p">]</span>

        <span class="n">table_meta</span> <span class="o">=</span> <span class="n">TableMetadataV3</span><span class="p">(</span><span class="n">keyspace_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">table_meta</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_table_options</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flags&#39;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">compact_static</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">table_meta</span><span class="o">.</span><span class="n">is_compact_storage</span> <span class="o">=</span> <span class="s1">&#39;dense&#39;</span> <span class="ow">in</span> <span class="n">flags</span> <span class="ow">or</span> <span class="s1">&#39;super&#39;</span> <span class="ow">in</span> <span class="n">flags</span> <span class="ow">or</span> <span class="s1">&#39;compound&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flags</span>
                <span class="n">is_dense</span> <span class="o">=</span> <span class="s1">&#39;dense&#39;</span> <span class="ow">in</span> <span class="n">flags</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">compact_static</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">table_meta</span><span class="o">.</span><span class="n">is_compact_storage</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">is_dense</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_build_table_columns</span><span class="p">(</span><span class="n">table_meta</span><span class="p">,</span> <span class="n">col_rows</span><span class="p">,</span> <span class="n">compact_static</span><span class="p">,</span> <span class="n">is_dense</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">trigger_row</span> <span class="ow">in</span> <span class="n">trigger_rows</span><span class="p">:</span>
                <span class="n">trigger_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_trigger_metadata</span><span class="p">(</span><span class="n">table_meta</span><span class="p">,</span> <span class="n">trigger_row</span><span class="p">)</span>
                <span class="n">table_meta</span><span class="o">.</span><span class="n">triggers</span><span class="p">[</span><span class="n">trigger_meta</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">trigger_meta</span>

            <span class="k">for</span> <span class="n">index_row</span> <span class="ow">in</span> <span class="n">index_rows</span><span class="p">:</span>
                <span class="n">index_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_index_metadata</span><span class="p">(</span><span class="n">table_meta</span><span class="p">,</span> <span class="n">index_row</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">index_meta</span><span class="p">:</span>
                    <span class="n">table_meta</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">index_meta</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_meta</span>

            <span class="n">table_meta</span><span class="o">.</span><span class="n">extensions</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;extensions&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">table_meta</span><span class="o">.</span><span class="n">_exc_info</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error while parsing metadata for table </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2"> row(</span><span class="si">%s</span><span class="s2">) columns(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">keyspace_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col_rows</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">table_meta</span>

    <span class="k">def</span> <span class="nf">_build_table_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Setup the mostly-non-schema table options, like caching settings &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">o</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">o</span><span class="p">))</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recognized_table_options</span> <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">row</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_table_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">col_rows</span><span class="p">,</span> <span class="n">compact_static</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_dense</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># partition key</span>
        <span class="n">partition_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">col_rows</span>
                          <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kind&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;partition_key&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">partition_rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">partition_rows</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">partition_rows</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">partition_rows</span><span class="p">:</span>
            <span class="c1"># we have to add meta here (and not in the later loop) because TableMetadata.columns is an</span>
            <span class="c1"># OrderedDict, and it assumes keys are inserted first, in order, when exporting CQL</span>
            <span class="n">column_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_column_metadata</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">column_meta</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_meta</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">partition_key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column_name&#39;</span><span class="p">)])</span>

        <span class="c1"># clustering key</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">compact_static</span><span class="p">:</span>
            <span class="n">clustering_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">col_rows</span>
                               <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kind&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;clustering&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clustering_rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">clustering_rows</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">clustering_rows</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">clustering_rows</span><span class="p">:</span>
                <span class="n">column_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_column_metadata</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                <span class="n">meta</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">column_meta</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_meta</span>
                <span class="n">meta</span><span class="o">.</span><span class="n">clustering_key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column_name&#39;</span><span class="p">)])</span>

        <span class="k">for</span> <span class="n">col_row</span> <span class="ow">in</span> <span class="p">(</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">col_rows</span>
                        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kind&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;partition_key&#39;</span><span class="p">,</span> <span class="s1">&#39;clustering_key&#39;</span><span class="p">)):</span>
            <span class="n">column_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_column_metadata</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">col_row</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_dense</span> <span class="ow">and</span> <span class="n">column_meta</span><span class="o">.</span><span class="n">cql_type</span> <span class="o">==</span> <span class="n">types</span><span class="o">.</span><span class="n">cql_empty_type</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">compact_static</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">column_meta</span><span class="o">.</span><span class="n">is_static</span><span class="p">:</span>
                <span class="c1"># for compact static tables, we omit the clustering key and value, and only add the logical columns.</span>
                <span class="c1"># They are marked not static so that it generates appropriate CQL</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">compact_static</span><span class="p">:</span>
                <span class="n">column_meta</span><span class="o">.</span><span class="n">is_static</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">column_meta</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_meta</span>

    <span class="k">def</span> <span class="nf">_build_view_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col_rows</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">keyspace_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;keyspace_name&quot;</span><span class="p">]</span>
        <span class="n">view_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;view_name&quot;</span><span class="p">]</span>
        <span class="n">base_table_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;base_table_name&quot;</span><span class="p">]</span>
        <span class="n">include_all_columns</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;include_all_columns&quot;</span><span class="p">]</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;where_clause&quot;</span><span class="p">]</span>
        <span class="n">col_rows</span> <span class="o">=</span> <span class="n">col_rows</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_table_col_rows</span><span class="p">[</span><span class="n">keyspace_name</span><span class="p">][</span><span class="n">view_name</span><span class="p">]</span>
        <span class="n">view_meta</span> <span class="o">=</span> <span class="n">MaterializedViewMetadata</span><span class="p">(</span><span class="n">keyspace_name</span><span class="p">,</span> <span class="n">view_name</span><span class="p">,</span> <span class="n">base_table_name</span><span class="p">,</span>
                                             <span class="n">include_all_columns</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_table_options</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_table_columns</span><span class="p">(</span><span class="n">view_meta</span><span class="p">,</span> <span class="n">col_rows</span><span class="p">)</span>
        <span class="n">view_meta</span><span class="o">.</span><span class="n">extensions</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;extensions&#39;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">return</span> <span class="n">view_meta</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_build_column_metadata</span><span class="p">(</span><span class="n">table_metadata</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;column_name&quot;</span><span class="p">]</span>
        <span class="n">cql_type</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
        <span class="n">is_static</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kind&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;static&quot;</span>
        <span class="n">is_reversed</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;clustering_order&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;DESC&quot;</span>
        <span class="n">column_meta</span> <span class="o">=</span> <span class="n">ColumnMetadata</span><span class="p">(</span><span class="n">table_metadata</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cql_type</span><span class="p">,</span> <span class="n">is_static</span><span class="p">,</span> <span class="n">is_reversed</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">column_meta</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_build_index_metadata</span><span class="p">(</span><span class="n">table_metadata</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index_name&quot;</span><span class="p">)</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kind&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index_name</span> <span class="ow">or</span> <span class="n">kind</span><span class="p">:</span>
            <span class="n">index_options</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;options&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">IndexMetadata</span><span class="p">(</span><span class="n">table_metadata</span><span class="o">.</span><span class="n">keyspace_name</span><span class="p">,</span> <span class="n">table_metadata</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">index_name</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">index_options</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_build_trigger_metadata</span><span class="p">(</span><span class="n">table_metadata</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;trigger_name&quot;</span><span class="p">]</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">]</span>
        <span class="n">trigger_meta</span> <span class="o">=</span> <span class="n">TriggerMetadata</span><span class="p">(</span><span class="n">table_metadata</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">trigger_meta</span>

    <span class="k">def</span> <span class="nf">_query_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="n">ConsistencyLevel</span><span class="o">.</span><span class="n">ONE</span>
        <span class="n">queries</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_KEYSPACES</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">),</span>
            <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_TABLES</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">),</span>
            <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_COLUMNS</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">),</span>
            <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_TYPES</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">),</span>
            <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_FUNCTIONS</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">),</span>
            <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_AGGREGATES</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">),</span>
            <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_TRIGGERS</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">),</span>
            <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_INDEXES</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">),</span>
            <span class="n">QueryMessage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SELECT_VIEWS</span><span class="p">,</span> <span class="n">consistency_level</span><span class="o">=</span><span class="n">cl</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">wait_for_responses</span><span class="p">(</span><span class="o">*</span><span class="n">queries</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">fail_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">(</span><span class="n">ks_success</span><span class="p">,</span> <span class="n">ks_result</span><span class="p">),</span> <span class="p">(</span><span class="n">table_success</span><span class="p">,</span> <span class="n">table_result</span><span class="p">),</span> \
        <span class="p">(</span><span class="n">col_success</span><span class="p">,</span> <span class="n">col_result</span><span class="p">),</span> <span class="p">(</span><span class="n">types_success</span><span class="p">,</span> <span class="n">types_result</span><span class="p">),</span> \
        <span class="p">(</span><span class="n">functions_success</span><span class="p">,</span> <span class="n">functions_result</span><span class="p">),</span> \
        <span class="p">(</span><span class="n">aggregates_success</span><span class="p">,</span> <span class="n">aggregates_result</span><span class="p">),</span> \
        <span class="p">(</span><span class="n">triggers_success</span><span class="p">,</span> <span class="n">triggers_result</span><span class="p">),</span> \
        <span class="p">(</span><span class="n">indexes_success</span><span class="p">,</span> <span class="n">indexes_result</span><span class="p">),</span> \
        <span class="p">(</span><span class="n">views_success</span><span class="p">,</span> <span class="n">views_result</span><span class="p">)</span> <span class="o">=</span> <span class="n">responses</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">keyspaces_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">(</span><span class="n">ks_success</span><span class="p">,</span> <span class="n">ks_result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">(</span><span class="n">table_success</span><span class="p">,</span> <span class="n">table_result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">(</span><span class="n">col_success</span><span class="p">,</span> <span class="n">col_result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triggers_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">(</span><span class="n">triggers_success</span><span class="p">,</span> <span class="n">triggers_result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">(</span><span class="n">types_success</span><span class="p">,</span> <span class="n">types_result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functions_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">(</span><span class="n">functions_success</span><span class="p">,</span> <span class="n">functions_result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregates_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">(</span><span class="n">aggregates_success</span><span class="p">,</span> <span class="n">aggregates_result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexes_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">(</span><span class="n">indexes_success</span><span class="p">,</span> <span class="n">indexes_result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">views_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_results</span><span class="p">(</span><span class="n">views_success</span><span class="p">,</span> <span class="n">views_result</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_results</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_aggregate_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SchemaParserV3</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_aggregate_results</span><span class="p">()</span>

        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_table_index_rows</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes_result</span><span class="p">:</span>
            <span class="n">ksname</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;keyspace_name&quot;</span><span class="p">]</span>
            <span class="n">cfname</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_name_col</span><span class="p">]</span>
            <span class="n">m</span><span class="p">[</span><span class="n">ksname</span><span class="p">][</span><span class="n">cfname</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_view_rows</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">views_result</span><span class="p">:</span>
            <span class="n">m</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;keyspace_name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_schema_type_to_cql</span><span class="p">(</span><span class="n">type_string</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">type_string</span>


<span class="k">class</span> <span class="nc">TableMetadataV3</span><span class="p">(</span><span class="n">TableMetadata</span><span class="p">):</span>
    <span class="n">compaction_options</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">option_maps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;compaction&#39;</span><span class="p">,</span> <span class="s1">&#39;compression&#39;</span><span class="p">,</span> <span class="s1">&#39;caching&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_cql_compatible</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_make_option_strings</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">options_copy</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">options_map</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">option_maps</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">options_copy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">options_copy</span><span class="p">[</span><span class="n">option</span><span class="p">]</span>
                <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = {</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">options_copy</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;comment&quot;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">protect_value</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>


<div class="viewcode-block" id="MaterializedViewMetadata"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.MaterializedViewMetadata">[docs]</a><span class="k">class</span> <span class="nc">MaterializedViewMetadata</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A representation of a materialized view on a table</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">keyspace_name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="sd">&quot;&quot;&quot; A string name of the view.&quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot; A string name of the view.&quot;&quot;&quot;</span>

    <span class="n">base_table_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot; A string name of the base table for this view.&quot;&quot;&quot;</span>

    <span class="n">partition_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A list of :class:`.ColumnMetadata` instances representing the columns in</span>
<span class="sd">    the partition key for this view.  This will always hold at least one</span>
<span class="sd">    column.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">clustering_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A list of :class:`.ColumnMetadata` instances representing the columns</span>
<span class="sd">    in the clustering key for this view.</span>

<span class="sd">    Note that a table may have no clustering keys, in which case this will</span>
<span class="sd">    be an empty list.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">columns</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dict mapping column names to :class:`.ColumnMetadata` instances.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">include_all_columns</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot; A flag indicating whether the view was created AS SELECT * &quot;&quot;&quot;</span>

    <span class="n">where_clause</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot; String WHERE clause for the view select statement. From server metadata &quot;&quot;&quot;</span>

    <span class="n">options</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dict mapping table option names to their specific settings for this</span>
<span class="sd">    view.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">extensions</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Metadata describing configuration for table extensions</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyspace_name</span><span class="p">,</span> <span class="n">view_name</span><span class="p">,</span> <span class="n">base_table_name</span><span class="p">,</span> <span class="n">include_all_columns</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyspace_name</span> <span class="o">=</span> <span class="n">keyspace_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">view_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_table_name</span> <span class="o">=</span> <span class="n">base_table_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partition_key</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_key</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include_all_columns</span> <span class="o">=</span> <span class="n">include_all_columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">where_clause</span> <span class="o">=</span> <span class="n">where_clause</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span> <span class="ow">or</span> <span class="p">{}</span>

<div class="viewcode-block" id="MaterializedViewMetadata.as_cql_query"><a class="viewcode-back" href="../../api/cassandra/metadata.html#cassandra.metadata.MaterializedViewMetadata.as_cql_query">[docs]</a>    <span class="k">def</span> <span class="nf">as_cql_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formatted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a CQL query that can be used to recreate this function.</span>
<span class="sd">        If `formatted` is set to :const:`True`, extra whitespace will</span>
<span class="sd">        be added to make the query more readable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    &#39;</span> <span class="k">if</span> <span class="n">formatted</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span>
        <span class="n">keyspace</span> <span class="o">=</span> <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyspace_name</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">selected_cols</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_all_columns</span> <span class="k">else</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">protect_name</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">base_table</span> <span class="o">=</span> <span class="n">protect_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_table_name</span><span class="p">)</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">where_clause</span>

        <span class="n">part_key</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">protect_name</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">partition_key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="s2">&quot;((</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">part_key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">part_key</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_key</span><span class="p">:</span>
            <span class="n">pk</span> <span class="o">+=</span> <span class="s2">&quot;, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">protect_name</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_key</span><span class="p">)</span>
        <span class="n">pk</span> <span class="o">+=</span> <span class="s2">&quot;)&quot;</span>

        <span class="n">properties</span> <span class="o">=</span> <span class="n">TableMetadataV3</span><span class="o">.</span><span class="n">_property_string</span><span class="p">(</span><span class="n">formatted</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;CREATE MATERIALIZED VIEW </span><span class="si">%(keyspace)s</span><span class="s2">.</span><span class="si">%(name)s</span><span class="s2"> AS</span><span class="si">%(sep)s</span><span class="s2">&quot;</span> \
               <span class="s2">&quot;SELECT </span><span class="si">%(selected_cols)s%(sep)s</span><span class="s2">&quot;</span> \
               <span class="s2">&quot;FROM </span><span class="si">%(keyspace)s</span><span class="s2">.</span><span class="si">%(base_table)s%(sep)s</span><span class="s2">&quot;</span> \
               <span class="s2">&quot;WHERE </span><span class="si">%(where_clause)s%(sep)s</span><span class="s2">&quot;</span> \
               <span class="s2">&quot;PRIMARY KEY </span><span class="si">%(pk)s%(sep)s</span><span class="s2">&quot;</span> \
               <span class="s2">&quot;WITH </span><span class="si">%(properties)s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">locals</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span><span class="p">:</span>
            <span class="n">registry</span> <span class="o">=</span> <span class="n">_RegisteredExtensionType</span><span class="o">.</span><span class="n">_extension_registry</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">viewkeys</span><span class="p">(</span><span class="n">registry</span><span class="p">)</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span><span class="p">:</span>  <span class="c1"># no viewkeys on OrderedMapSerializeKey</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="n">registry</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">cql</span> <span class="o">=</span> <span class="n">ext</span><span class="o">.</span><span class="n">after_table_cql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">cql</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cql</span><span class="p">,)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="k">def</span> <span class="nf">export_as_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_cql_query</span><span class="p">(</span><span class="n">formatted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span></div>


<span class="k">def</span> <span class="nf">get_schema_parser</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">server_version</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
    <span class="n">server_major_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">server_version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">server_major_version</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SchemaParserV3</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># we could further specialize by version. Right now just refactoring the</span>
        <span class="c1"># multi-version parser we have as of C* 2.2.0rc1.</span>
        <span class="k">return</span> <span class="n">SchemaParserV22</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_cql_from_cass_type</span><span class="p">(</span><span class="n">cass_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A string representation of the type for this column, such as &quot;varchar&quot;</span>
<span class="sd">    or &quot;map&lt;string, int&gt;&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">cass_type</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ReversedType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cass_type</span><span class="o">.</span><span class="n">subtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cql_parameterized_type</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cass_type</span><span class="o">.</span><span class="n">cql_parameterized_type</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Cassandra Driver 3.12.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../cassandra.html" >cassandra</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2013-2017 DataStax.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.3.
    </div>
  </body>
</html>